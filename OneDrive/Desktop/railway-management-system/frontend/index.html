<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .navbar-brand { font-weight: bold; }
        .hero-section { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); 
            color: white; 
            padding: 120px 0; 
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            opacity: 0.3;
        }
        .hero-content { position: relative; z-index: 1; }
        .card { 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); 
            border: none; 
            margin-bottom: 20px; 
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        .btn-primary { 
            background: var(--primary-gradient); 
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { 
            background: var(--secondary-gradient);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-success {
            background: var(--success-gradient);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .train-card { 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            cursor: pointer;
            border-radius: 15px;
            overflow: hidden;
        }
        .train-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }
        .booking-summary { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            border-radius: 15px; 
            padding: 25px;
            border: 1px solid #dee2e6;
        }
        .page { display: none; }
        .page.active { display: block !important; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-dialog { max-width: 600px; width: 90%; }
        .alert { margin-bottom: 20px; border-radius: 10px; }
        .passenger-form { 
            border: 2px solid #e9ecef; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        .chat-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
        }
        .chat-window.show { display: flex; }
        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            font-weight: 600;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            border-radius: 0 0 15px 15px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message.user {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
        }
        .message.bot {
            background: #f1f3f4;
            color: #333;
        }
        .payment-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #dee2e6;
        }
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .payment-method {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .payment-method:hover, .payment-method.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .payment-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }
        .upi-apps {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .upi-app {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .upi-app:hover, .upi-app.selected {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .upi-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            margin: 0 auto 5px;
        }
        .wallet-info {
            text-align: center;
        }
        .quick-amounts {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .add-money-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .add-money-methods .payment-method {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .add-money-methods .payment-method:hover,
        .add-money-methods .payment-method.selected {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .navbar {
            background: var(--dark-gradient) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .nav-tabs .nav-link { cursor: pointer; }
        .nav-tabs .nav-link.active { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showPage('home')">
                <i class="fas fa-train me-2"></i>
                Railway Management
            </a>
            
            <div class="navbar-nav ms-auto" id="navLinks">
                <a class="nav-link" href="#" onclick="showPage('login')">Login</a>
                <a class="nav-link" href="#" onclick="showPage('register')">Register</a>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="home" class="page active">
        <div class="hero-section text-center">
            <div class="container hero-content">
                <h1 class="display-4 mb-4">Welcome to Railway Management System</h1>
                <p class="lead mb-4">Book your train tickets easily and manage your journeys with our modern platform</p>
                <div id="homeButtons">
                    <button class="btn btn-light btn-lg me-3" onclick="showPage('register')">Get Started</button>
                    <button class="btn btn-outline-light btn-lg" onclick="showPage('login')">Login</button>
                </div>
            </div>
        </div>

        <div class="container my-5">
            <div class="row">
                <div class="col-md-4">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <i class="fas fa-search fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Search Trains</h5>
                            <p class="card-text">Find trains between any two stations with real-time availability</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <i class="fas fa-ticket-alt fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Easy Booking</h5>
                            <p class="card-text">Book tickets for multiple passengers with secure payment</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 text-center">
                        <div class="card-body">
                            <i class="fas fa-history fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">Manage Bookings</h5>
                            <p class="card-text">View and manage all your bookings in one place</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login" class="page">
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-center mb-4">Login</h3>
                            
                            <div id="loginError" class="alert alert-danger" style="display: none;"></div>

                            <form id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="loginUsername" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    <span id="loginBtnText">Login</span>
                                    <span id="loginSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                                </button>
                            </form>

                            <div class="text-center mt-3">
                                <p>Don't have an account? <a href="#" onclick="showPage('register')">Register here</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register" class="page">
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title text-center mb-4">Register</h3>
                            
                            <div id="registerError" class="alert alert-danger" style="display: none;"></div>
                            <div id="registerSuccess" class="alert alert-success" style="display: none;"></div>

                            <form id="registerForm">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="registerUsername" required minlength="3" maxlength="50">
                                    <div class="invalid-feedback" id="usernameError"></div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="registerName" required minlength="1" maxlength="255">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="registerEmail" required>
                                    <div class="invalid-feedback" id="emailError"></div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Phone (10 digits)</label>
                                    <input type="tel" class="form-control" id="registerPhone" pattern="[0-9]{10}" maxlength="10">
                                    <small class="text-muted">Enter 10-digit phone number</small>
                                    <div class="invalid-feedback" id="phoneError"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Password (minimum 8 characters)</label>
                                    <input type="password" class="form-control" id="registerPassword" required minlength="8">
                                    <div class="password-strength mt-2" id="passwordStrength" style="display: none;">
                                        <div class="progress" style="height: 5px;">
                                            <div class="progress-bar" id="strengthBar" style="width: 0%;"></div>
                                        </div>
                                        <small id="strengthText" class="text-muted"></small>
                                    </div>
                                    <div class="invalid-feedback" id="passwordError"></div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    <span id="registerBtnText">Register</span>
                                    <span id="registerSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                                </button>
                            </form>

                            <div class="text-center mt-3">
                                <p>Already have an account? <a href="#" onclick="showPage('login')">Login here</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Page -->
    <div id="search" class="page">
        <div class="container mt-4">
            <h2 class="mb-4">Search Trains</h2>
            
            <div class="card mb-4">
                <div class="card-body">
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">From</label>
                                <select class="form-select" id="sourceStation" required onchange="loadRoutesForStations()">
                                    <option value="">Select Station</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">To</label>
                                <select class="form-select" id="destinationStation" required onchange="loadRoutesForStations()">
                                    <option value="">Select Station</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Travel Date</label>
                                <input type="date" class="form-control" id="travelDate" required>
                            </div>
                            
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <span id="searchBtnText">Search</span>
                                    <span id="searchSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="routeInfo" class="alert alert-info" style="display: none;"></div>

            <div id="trainResults" class="row"></div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page">
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-user-circle fa-5x text-primary mb-3"></i>
                            <h4 id="profileUsername">Username</h4>
                            <p class="text-muted" id="profileEmail">email@example.com</p>
                            <p class="text-muted" id="profilePhone">+91-9876543210</p>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-wallet me-2"></i>My Wallet</h5>
                        </div>
                        <div class="card-body text-center">
                            <h3 class="text-success">₹<span id="profileWalletBalance">0.00</span></h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddMoneyModal()">Add Money</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>Account Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Full Name:</strong></div>
                                <div class="col-sm-9" id="profileFullName">John Doe</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Username:</strong></div>
                                <div class="col-sm-9" id="profileUsernameDetail">johndoe</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Email:</strong></div>
                                <div class="col-sm-9" id="profileEmailDetail">john@example.com</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Phone:</strong></div>
                                <div class="col-sm-9" id="profilePhoneDetail">+91-9876543210</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Member Since:</strong></div>
                                <div class="col-sm-9" id="profileMemberSince">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Payment Methods</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Saved Credit Cards</h6>
                                <div id="savedCards">
                                    <!-- Saved cards will be loaded here -->
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="showAddCardModal()">Add New Card</button>
                            </div>
                            
                            <div class="mb-3">
                                <h6>UPI IDs</h6>
                                <div id="savedUpiIds">
                                    <!-- Saved UPI IDs will be loaded here -->
                                </div>
                                <button class="btn btn-outline-success btn-sm" onclick="showAddUpiModal()">Add UPI ID</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Recent Wallet Transactions</h5>
                        </div>
                        <div class="card-body">
                            <div id="profileTransactions">
                                <!-- Transactions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Page -->
    <div id="bookings" class="page">
        <div class="container mt-4">
            <h2 class="mb-4">My Bookings</h2>
            <div id="bookingsList"></div>
        </div>
    </div>
    
    <!-- Edit Booking Modal -->
    <div id="editBookingModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Booking</h5>
                    <button type="button" class="btn-close" onclick="closeEditBookingModal()"></button>
                </div>
                <div class="modal-body">
                    <div id="editBookingDetails"></div>
                    <div id="editPassengerForms"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditBookingModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBookingChanges()">
                        <span id="editBookingBtnText">Save Changes</span>
                        <span id="editBookingSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Page -->
    <div id="admin" class="page">
        <div class="container mt-4">
            <h2 class="mb-4">Railway Admin Dashboard</h2>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="adminTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="trains">Train Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="routes">Route Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="bookings">Booking Oversight</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="users">User Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="reports">Reports</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="refunds">Refund Management</a>
                </li>
            </ul>
            
            <!-- Dashboard Tab -->
            <div id="admin-dashboard" class="admin-tab-content active">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <h3 id="totalTrains">0</h3>
                                <p>Active Trains</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <h3 id="totalBookings">0</h3>
                                <p>Total Bookings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-warning text-white">
                            <div class="card-body">
                                <h3 id="totalRevenue">₹0</h3>
                                <p>Revenue Today</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body">
                                <h3 id="activeUsers">0</h3>
                                <p>Active Users</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Recent Bookings</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentBookings"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">System Alerts</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshSystemAlerts()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="systemAlerts">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Train Management Tab -->
            <div id="admin-trains" class="admin-tab-content">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Train Management</h4>
                    <div>
                        <button class="btn btn-info me-2" onclick="syncRoutesWithTrains()">Sync Routes</button>
                        <button class="btn btn-primary" onclick="showAddTrainForm()">Add New Train</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="trainsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Route Management Tab -->
            <div id="admin-routes" class="admin-tab-content">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Route Management</h4>
                    <div>
                        <button class="btn btn-info me-2" onclick="bulkCreateSchedules()">Create All Schedules</button>
                        <button class="btn btn-primary" onclick="showAddRouteForm()">Add New Route</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="routesList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Booking Oversight Tab -->
            <div id="admin-bookings" class="admin-tab-content">
                <h4>Booking Oversight</h4>
                <div class="card">
                    <div class="card-body">
                        <div id="allBookings"></div>
                    </div>
                </div>
            </div>
            
            <!-- User Management Tab -->
            <div id="admin-users" class="admin-tab-content">
                <h4>User Management</h4>
                <div class="card">
                    <div class="card-body">
                        <div id="usersList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="admin-reports" class="admin-tab-content">
                <h4>Reports & Analytics</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Revenue Report</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Booking Trends</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="bookingChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Refund Management Tab -->
            <div id="admin-refunds" class="admin-tab-content">
                <h4>Refund Request Management</h4>
                <div class="card">
                    <div class="card-body">
                        <div id="refundRequestsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Train Modal -->
    <div id="addTrainModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Train</h5>
                    <button type="button" class="btn-close" onclick="closeAddTrainModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="addTrainForm">
                        <div class="mb-3">
                            <label class="form-label">Train Number</label>
                            <input type="text" class="form-control" id="trainNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Train Name</label>
                            <input type="text" class="form-control" id="trainName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="trainType" required>
                                <option value="express">Express</option>
                                <option value="superfast">Superfast</option>
                                <option value="passenger">Passenger</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Seats</label>
                            <input type="number" class="form-control" id="totalSeats" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTrainModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addTrain()">Add Train</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Train Modal -->
    <div id="editTrainModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Train</h5>
                    <button type="button" class="btn-close" onclick="closeEditTrainModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editTrainForm">
                        <div class="mb-3">
                            <label class="form-label">Train Number</label>
                            <input type="text" class="form-control" id="editTrainNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Train Name</label>
                            <input type="text" class="form-control" id="editTrainName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="editTrainType" required>
                                <option value="express">Express</option>
                                <option value="superfast">Superfast</option>
                                <option value="passenger">Passenger</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Seats</label>
                            <input type="number" class="form-control" id="editTotalSeats" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTrainModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTrainChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Book Ticket</h5>
                    <button type="button" class="btn-close" onclick="closeBookingModal()"></button>
                </div>
                <div class="modal-body">
                    <div id="trainDetails" class="booking-summary mb-4"></div>
                    
                    <h6>Passenger Details</h6>
                    <div id="passengerForms"></div>
                    
                    <button class="btn btn-secondary mb-3" onclick="addPassenger()">Add Passenger</button>
                    
                    <div class="booking-summary">
                        <h6>Total Amount: ₹<span id="totalAmount">0</span></h6>
                    </div>
                    
                    <div class="payment-section">
                        <h6>Payment Method</h6>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPayment('card')">
                                <i class="fas fa-credit-card fa-2x mb-2 text-primary"></i>
                                <div><strong>Credit/Debit Card</strong></div>
                                <small class="text-muted">Visa, MasterCard, RuPay</small>
                            </div>
                            <div class="payment-method" onclick="selectPayment('upi')">
                                <i class="fas fa-mobile-alt fa-2x mb-2 text-success"></i>
                                <div><strong>UPI</strong></div>
                                <small class="text-muted">Google Pay, PhonePe, Paytm</small>
                            </div>
                            <div class="payment-method" onclick="selectPayment('wallet')">
                                <i class="fas fa-wallet fa-2x mb-2 text-warning"></i>
                                <div><strong>Digital Wallet</strong></div>
                                <small class="text-muted">Balance: ₹<span id="walletBalance">0.00</span></small>
                            </div>
                        </div>
                        
                        <!-- Card Payment Form -->
                        <div id="cardPaymentForm" class="payment-form" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Select Saved Card or Add New</label>
                                <div id="savedCardsList">
                                    <!-- Saved cards will be loaded here -->
                                </div>
                            </div>
                            
                            <div id="newCardForm" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Cardholder Name</label>
                                        <input type="text" class="form-control" id="cardholderName" placeholder="John Doe">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Expiry Month</label>
                                        <select class="form-select" id="expiryMonth">
                                            <option value="">MM</option>
                                            <option value="01">01</option>
                                            <option value="02">02</option>
                                            <option value="03">03</option>
                                            <option value="04">04</option>
                                            <option value="05">05</option>
                                            <option value="06">06</option>
                                            <option value="07">07</option>
                                            <option value="08">08</option>
                                            <option value="09">09</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Expiry Year</label>
                                        <select class="form-select" id="expiryYear">
                                            <option value="">YYYY</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                            <option value="2027">2027</option>
                                            <option value="2028">2028</option>
                                            <option value="2029">2029</option>
                                            <option value="2030">2030</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="password" class="form-control" id="cvv" placeholder="123" maxlength="3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- UPI Payment Form -->
                        <div id="upiPaymentForm" class="payment-form" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Select Saved UPI or Add New</label>
                                <div id="savedUpisList">
                                    <!-- Saved UPI IDs will be loaded here -->
                                </div>
                            </div>
                            
                            <div id="newUpiForm" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Select UPI App</label>
                                    <div class="upi-apps">
                                        <div class="upi-app" onclick="selectUpiApp('googlepay')">
                                            <img src="https://developers.google.com/pay/api/images/brand-guidelines/google-pay-mark.png" alt="Google Pay" width="40">
                                            <div>Google Pay</div>
                                        </div>
                                        <div class="upi-app" onclick="selectUpiApp('phonepe')">
                                            <div class="upi-icon" style="background: #5f259f;">PhonePe</div>
                                        </div>
                                        <div class="upi-app" onclick="selectUpiApp('paytm')">
                                            <div class="upi-icon" style="background: #00baf2;">Paytm</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">UPI ID</label>
                                    <input type="text" class="form-control" id="upiId" placeholder="9876543210@paytm" readonly>
                                    <small class="text-muted">Select an app above to auto-generate UPI ID</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Wallet Payment Form -->
                        <div id="walletPaymentForm" class="payment-form" style="display: none;">
                            <div class="wallet-info">
                                <div class="text-center mb-3">
                                    <h4 class="text-primary">₹<span id="currentWalletBalance">0.00</span></h4>
                                    <small class="text-muted">Available Balance</small>
                                </div>
                                <div id="walletInsufficientFunds" class="alert alert-warning" style="display: none;">
                                    Insufficient wallet balance. Please add money to your wallet.
                                    <button class="btn btn-sm btn-primary ms-2" onclick="showAddMoneyModal()">Add Money</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBooking()">
                        <span id="bookingBtnText">Confirm Booking</span>
                        <span id="bookingSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Route</h5>
                    <button type="button" class="btn-close" onclick="closeAddRouteModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="addRouteForm">
                        <div class="mb-3">
                            <label class="form-label">Train</label>
                            <select class="form-select" id="routeTrainId" required>
                                <option value="">Select Train</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Station</label>
                            <select class="form-select" id="routeSourceStation" required>
                                <option value="">Select Source Station</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destination Station</label>
                            <select class="form-select" id="routeDestinationStation" required>
                                <option value="">Select Destination Station</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departure Time</label>
                                <input type="time" class="form-control" id="routeDepartureTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Arrival Time</label>
                                <input type="time" class="form-control" id="routeArrivalTime" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distance (km)</label>
                                <input type="number" class="form-control" id="routeDistance" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base Fare (₹)</label>
                                <input type="number" class="form-control" id="routeBaseFare" min="1" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddRouteModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addRoute()">Add Route</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Route Modal -->
    <div id="editRouteModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Route</h5>
                    <button type="button" class="btn-close" onclick="closeEditRouteModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editRouteForm">
                        <div class="mb-3">
                            <label class="form-label">Train</label>
                            <select class="form-select" id="editRouteTrainId" required>
                                <option value="">Select Train</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Station</label>
                            <select class="form-select" id="editRouteSourceStation" required>
                                <option value="">Select Source Station</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destination Station</label>
                            <select class="form-select" id="editRouteDestinationStation" required>
                                <option value="">Select Destination Station</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departure Time</label>
                                <input type="time" class="form-control" id="editRouteDepartureTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Arrival Time</label>
                                <input type="time" class="form-control" id="editRouteArrivalTime" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Distance (km)</label>
                                <input type="number" class="form-control" id="editRouteDistance" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base Fare (₹)</label>
                                <input type="number" class="form-control" id="editRouteBaseFare" min="1" step="0.01" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditRouteModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRouteChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Money to Wallet</h5>
                    <button type="button" class="btn-close" onclick="closeAddMoneyModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h4 class="text-primary">Current Balance: ₹<span id="modalWalletBalance">0.00</span></h4>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Amount to Add</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="addMoneyAmount" placeholder="0.00" min="1" step="0.01">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Quick Amount</label>
                        <div class="quick-amounts">
                            <button class="btn btn-outline-primary btn-sm" onclick="setQuickAmount(100)">₹100</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="setQuickAmount(500)">₹500</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="setQuickAmount(1000)">₹1000</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="setQuickAmount(2000)">₹2000</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Payment Method for Adding Money</label>
                        <div class="add-money-methods">
                            <div class="payment-method" onclick="selectAddMoneyMethod('card')">
                                <i class="fas fa-credit-card fa-2x mb-2 text-primary"></i>
                                <div>Credit/Debit Card</div>
                            </div>
                            <div class="payment-method" onclick="selectAddMoneyMethod('upi')">
                                <i class="fas fa-mobile-alt fa-2x mb-2 text-success"></i>
                                <div>UPI</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddMoneyModal()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addMoneyToWallet()">
                        <span id="addMoneyBtnText">Add Money</span>
                        <span id="addMoneySpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Widget -->
    <div class="chat-widget">
        <button class="chat-toggle" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
        </button>
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <i class="fas fa-robot me-2"></i>
                Railway Assistant
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    Hello! I'm your railway assistant. How can I help you today?
                </div>
            </div>
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Ask me anything..." onkeypress="handleChatKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Define showPage function first to ensure it's available immediately
        function showPage(pageId) {
            console.log('Showing page:', pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'none';
        }

        const API_BASE_URL = 'http://localhost:8000';
        const PERPLEXITY_API_KEY = 'YOUR_PERPLEXITY_API_KEY';
        let currentUser = null;
        let stations = [];
        let selectedTrain = null;
        let passengers = [{ name: '', age: '', gender: 'male' }];
        let selectedUpiApp = null;
        let walletBalance = 0;
        let selectedAddMoneyMethod = null;
        let selectedCardId = null;
        let selectedUpiId = null;
        let savedCards = [];
        let selectedPaymentMethod = null;
        let selectedPaymentMethodType = null;
        let selectedUpiIndex = null;

        // Debug function to test UPI endpoints specifically
        window.testUpiEndpoints = async function() {
            console.log('=== Testing UPI Endpoints ===');
            
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found. Please login first.');
                return;
            }
            
            try {
                console.log('1. Testing GET /payments/upi-ids');
                const upiIds = await apiRequest('/payments/upi-ids');
                console.log('UPI IDs response:', upiIds);
                
                console.log('2. Testing POST /payments/upi-ids (creating test UPI)');
                const testUpi = {
                    upi_id: '9876543210@paytm',
                    initial_balance: 50000
                };
                
                try {
                    const newUpi = await apiRequest('/payments/upi-ids', {
                        method: 'POST',
                        body: JSON.stringify(testUpi)
                    });
                    console.log('Created UPI:', newUpi);
                    
                    console.log('3. Testing GET /payments/upi-ids again');
                    const updatedUpiIds = await apiRequest('/payments/upi-ids');
                    console.log('Updated UPI IDs:', updatedUpiIds);
                    
                } catch (createErr) {
                    console.error('Failed to create test UPI:', createErr);
                }
                
            } catch (err) {
                console.error('UPI endpoints test failed:', err);
            }
            
            console.log('=== End UPI Test ===');
        };

        // Debug function to check authentication status
        window.checkAuthStatus = function() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            console.log('=== Authentication Status ===');
            console.log('Token present:', !!token);
            console.log('User data present:', !!user);
            console.log('Current user object:', currentUser);
            
            if (token) {
                console.log('Token preview:', token.substring(0, 20) + '...');
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    console.log('User data:', userData);
                } catch (e) {
                    console.error('Invalid user data in localStorage');
                }
            }
            
            console.log('=== End Status ===');
        };

        // Debug function to test payment methods loading
        window.testPaymentMethods = async function() {
            console.log('Testing payment methods loading...');
            
            // First check if user is authenticated
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            console.log('Token:', token ? 'Present' : 'Missing');
            console.log('User:', user ? JSON.parse(user) : 'Missing');
            
            if (!token) {
                console.error('No authentication token found. Please login first.');
                return;
            }
            
            try {
                console.log('Testing credit cards endpoint...');
                const cards = await apiRequest('/payments/credit-cards');
                console.log('Cards loaded:', cards);
                
                console.log('Testing UPI IDs endpoint...');
                const upiIds = await apiRequest('/payments/upi-ids');
                console.log('UPI IDs loaded:', upiIds);
                
                console.log('Testing wallet endpoint...');
                const wallet = await apiRequest('/payments/wallet');
                console.log('Wallet loaded:', wallet);
                
                console.log('Payment methods test completed successfully');
            } catch (err) {
                console.error('Payment methods test failed:', err);
                console.error('Error details:', {
                    message: err.message,
                    stack: err.stack
                });
            }
        };

        // Debug function to test page navigation
        window.testPageNavigation = function() {
            console.log('Testing page navigation...');
            const pages = ['home', 'login', 'register'];
            pages.forEach(pageId => {
                const page = document.getElementById(pageId);
                console.log(`Page ${pageId}:`, page ? 'exists' : 'missing');
                if (page) {
                    console.log(`  - Display: ${window.getComputedStyle(page).display}`);
                    console.log(`  - Classes: ${page.className}`);
                }
            });
        };
        
        // Force show a page (for debugging)
        window.forceShowPage = function(pageId) {
            console.log(`Force showing page: ${pageId}`);
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
                p.classList.remove('active');
            });
            const page = document.getElementById(pageId);
            if (page) {
                page.style.display = 'block';
                page.classList.add('active');
                console.log(`Page ${pageId} should now be visible`);
            } else {
                console.log(`Page ${pageId} not found!`);
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            checkAuth();
            loadStations();
            setupEventListeners();
            setMinDate();
            setupCardNumberFormatting();
            
            // Debug: Log all page elements
            const pages = document.querySelectorAll('.page');
            console.log('Found pages:', pages.length);
            pages.forEach(page => {
                console.log('Page:', page.id, 'Display:', window.getComputedStyle(page).display);
            });
        });
        
        function showAddMoneyModal() {
            document.getElementById('modalWalletBalance').textContent = walletBalance.toFixed(2);
            document.getElementById('addMoneyModal').classList.add('show');
        }

        function closeAddMoneyModal() {
            document.getElementById('addMoneyModal').classList.remove('show');
            document.getElementById('addMoneyAmount').value = '';
            selectedAddMoneyMethod = null;
            document.querySelectorAll('.add-money-methods .payment-method').forEach(el => el.classList.remove('selected'));
        }

        function setQuickAmount(amount) {
            document.getElementById('addMoneyAmount').value = amount;
        }

        function selectAddMoneyMethod(method) {
            selectedAddMoneyMethod = method;
            document.querySelectorAll('.add-money-methods .payment-method').forEach(el => el.classList.remove('selected'));
            event.target.closest('.payment-method').classList.add('selected');
        }

        async function addMoneyToWallet() {
            const amount = parseFloat(document.getElementById('addMoneyAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!selectedAddMoneyMethod) {
                alert('Please select a payment method');
                return;
            }
            
            setLoading('addMoney', true);
            
            try {
                // Simulate payment processing for adding money
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Add money to wallet via API
                const response = await apiRequest('/payments/wallet/add-money', {
                    method: 'POST',
                    body: JSON.stringify({ amount: amount })
                });
                
                alert(`₹${amount} added to wallet successfully!`);
                walletBalance += amount;
                
                updateWalletDisplays();
                
                closeAddMoneyModal();
                checkWalletBalance(); // Recheck if wallet payment is now possible
                
            } catch (err) {
                alert('Failed to add money: ' + err.message);
            } finally {
                setLoading('addMoney', false);
            }
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (token && userData) {
                try {
                    currentUser = JSON.parse(userData);
                    // Verify token is still valid by making a test request
                    apiRequest('/auth/me').then(() => {
                        updateNavbar();
                    }).catch(() => {
                        // Token is invalid, clear auth data
                        console.warn('Token expired or invalid, clearing auth data');
                        logout();
                    });
                } catch (e) {
                    console.error('Invalid user data in localStorage:', e);
                    logout();
                }
            } else {
                updateNavbar();
            }
        }

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const homeButtons = document.getElementById('homeButtons');
            
            if (currentUser) {
                if (currentUser.role === 'admin') {
                    navLinks.innerHTML = `
                        <a class="nav-link" href="#" onclick="showPage('admin')">Admin Panel</a>
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                    `;
                } else {
                    navLinks.innerHTML = `
                        <a class="nav-link" href="#" onclick="showPage('search')">Search Trains</a>
                        <a class="nav-link" href="#" onclick="showPage('bookings')">My Bookings</a>
                        <a class="nav-link" href="#" onclick="showPage('profile')">Profile</a>
                        <div class="nav-link text-light">₹<span id="navWalletBalance">0.00</span></div>
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                    `;
                }
                homeButtons.innerHTML = `
                    <button class="btn btn-light btn-lg" onclick="showPage('${currentUser.role === 'admin' ? 'admin' : 'search'}')">Get Started</button>
                `;
            } else {
                navLinks.innerHTML = `
                    <a class="nav-link" href="#" onclick="showPage('login')">Login</a>
                    <a class="nav-link" href="#" onclick="showPage('register')">Register</a>
                `;
                homeButtons.innerHTML = `
                    <button class="btn btn-light btn-lg me-3" onclick="showPage('register')">Get Started</button>
                    <button class="btn btn-outline-light btn-lg" onclick="showPage('login')">Login</button>
                `;
            }
        }

        function showPage(pageId) {
            console.log('Attempting to show page:', pageId);
            
            try {
                // Clear any existing errors when switching pages
                document.querySelectorAll('.alert').forEach(alert => alert.style.display = 'none');
                
                // Hide all pages first
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });
                
                // Show the selected page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    targetPage.style.display = 'block';
                    console.log('Successfully showed page:', pageId);
                } else {
                    console.error('Page not found:', pageId);
                    return;
                }
                
                // Reset forms when showing login/register pages
                if (pageId === 'login') {
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) loginForm.reset();
                    hideError('loginError');
                }
                if (pageId === 'register') {
                    const registerForm = document.getElementById('registerForm');
                    if (registerForm) registerForm.reset();
                    hideError('registerError');
                    hideError('registerSuccess');
                    const passwordStrength = document.getElementById('passwordStrength');
                    if (passwordStrength) passwordStrength.style.display = 'none';
                }
                
                // Handle authentication-required pages
                if ((pageId === 'search' || pageId === 'bookings' || pageId === 'profile' || pageId === 'admin') && !currentUser) {
                    alert('Please login to access this page');
                    showPage('login');
                    return;
                }
                
                // Load page-specific data
                if (pageId === 'profile' && currentUser) {
                    loadProfile();
                }
                if (pageId === 'bookings' && currentUser) {
                    loadBookings();
                }
                if (pageId === 'admin' && currentUser?.role === 'admin') {
                    loadAdminDashboard();
                }
            } catch (error) {
                console.error('Error in showPage:', error);
                // Fallback: ensure at least the target page is visible
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'block';
                }
            }
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('travelDate').min = today;
        }

        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { Authorization: `Bearer ${token}` }),
                },
                ...options,
            };

            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            
            if (response.status === 401) {
                // Token expired or invalid
                console.warn('Authentication failed, logging out user');
                logout();
                throw new Error('Authentication expired. Please login again.');
            }
            
            if (response.status === 403) {
                // User is banned
                const error = await response.json();
                if (error.detail && error.detail.includes('temporarily blocked')) {
                    logout();
                    showBanPopup();
                    throw new Error('Account banned');
                }
            }
            
            if (!response.ok) {
                let errorMessage = 'API request failed';
                try {
                    const error = await response.json();
                    errorMessage = error.detail || error.message || `HTTP ${response.status}: ${response.statusText}`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            return response.json();
        }

        async function loadStations() {
            try {
                stations = await apiRequest('/stations/');
                const sourceSelect = document.getElementById('sourceStation');
                const destSelect = document.getElementById('destinationStation');
                
                stations.forEach(station => {
                    const option = `<option value="${station.id}">${station.name} (${station.code})</option>`;
                    sourceSelect.innerHTML += option;
                    destSelect.innerHTML += option;
                });
            } catch (err) {
                console.error('Failed to load stations:', err);
            }
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            
            // Add real-time validation
            document.getElementById('registerUsername').addEventListener('blur', validateUsername);
            document.getElementById('registerEmail').addEventListener('blur', validateEmail);
            document.getElementById('registerPhone').addEventListener('input', validatePhone);
            document.getElementById('registerPassword').addEventListener('input', validatePassword);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            setLoading('login', true);
            hideError('loginError');

            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password }),
                });
                
                localStorage.setItem('token', response.access_token);
                localStorage.setItem('user', JSON.stringify(response.user));
                currentUser = response.user;
                updateNavbar();
                
                // Redirect based on user role
                if (currentUser.role === 'admin') {
                    showPage('admin');
                } else {
                    showPage('search');
                }
            } catch (err) {
                if (err.message.includes('temporarily blocked')) {
                    showBanPopup();
                } else {
                    showError('loginError', err.message);
                }
            } finally {
                setLoading('login', false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            // Validate all fields before submission
            const isValid = await validateAllFields();
            if (!isValid) {
                return;
            }
            
            const formData = {
                username: document.getElementById('registerUsername').value,
                full_name: document.getElementById('registerName').value,
                email: document.getElementById('registerEmail').value,
                phone: document.getElementById('registerPhone').value || null,
                password: document.getElementById('registerPassword').value,
            };
            
            setLoading('register', true);
            hideError('registerError');
            hideError('registerSuccess');

            try {
                await apiRequest('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(formData),
                });
                
                showError('registerSuccess', 'Registration successful! Please login.');
                document.getElementById('registerForm').reset();
                document.getElementById('passwordStrength').style.display = 'none';
                setTimeout(() => showPage('login'), 2000);
            } catch (err) {
                showError('registerError', err.message);
            } finally {
                setLoading('register', false);
            }
        }
        
        async function validateAllFields() {
            const username = await validateUsername();
            const email = await validateEmail();
            const phone = validatePhone();
            const password = validatePassword();
            
            return username && email && phone && password;
        }
        
        async function validateUsername() {
            const username = document.getElementById('registerUsername').value;
            const errorDiv = document.getElementById('usernameError');
            const input = document.getElementById('registerUsername');
            
            if (!username || username.length < 3) {
                showFieldError(input, errorDiv, 'Username must be at least 3 characters long');
                return false;
            }
            
            if (username.length > 50) {
                showFieldError(input, errorDiv, 'Username must be less than 50 characters');
                return false;
            }
            
            // Check if username is unique
            try {
                const response = await fetch(`${API_BASE_URL}/auth/check-username`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    if (error.detail.includes('already exists')) {
                        showFieldError(input, errorDiv, 'Username already taken');
                        return false;
                    }
                }
            } catch (err) {
                // If check fails, continue (will be caught during registration)
            }
            
            hideFieldError(input, errorDiv);
            return true;
        }
        
        async function validateEmail() {
            const email = document.getElementById('registerEmail').value;
            const errorDiv = document.getElementById('emailError');
            const input = document.getElementById('registerEmail');
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                showFieldError(input, errorDiv, 'Please enter a valid email address');
                return false;
            }
            
            hideFieldError(input, errorDiv);
            return true;
        }
        
        function validatePhone() {
            const phone = document.getElementById('registerPhone').value;
            const errorDiv = document.getElementById('phoneError');
            const input = document.getElementById('registerPhone');
            
            if (phone && (phone.length !== 10 || !/^[0-9]{10}$/.test(phone))) {
                showFieldError(input, errorDiv, 'Phone number must be exactly 10 digits');
                return false;
            }
            
            hideFieldError(input, errorDiv);
            return true;
        }
        
        async function validatePassword() {
            const password = document.getElementById('registerPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const input = document.getElementById('registerPassword');
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (!password || password.length < 8) {
                showFieldError(input, errorDiv, 'Password must be at least 8 characters long');
                strengthDiv.style.display = 'none';
                return false;
            }
            
            // Check password strength
            try {
                const response = await fetch(`${API_BASE_URL}/auth/check-password-strength`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updatePasswordStrength(result.strength);
                    
                    if (result.strength === 'weak') {
                        showFieldError(input, errorDiv, 'Password is too weak. Use a mix of uppercase, lowercase, numbers, and symbols');
                        return false;
                    }
                }
            } catch (err) {
                // If strength check fails, show basic strength indicator
                const strength = calculatePasswordStrength(password);
                updatePasswordStrength(strength);
            }
            
            hideFieldError(input, errorDiv);
            return true;
        }
        
        function calculatePasswordStrength(password) {
            let score = 0;
            
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++;
            
            if (score <= 2) return 'weak';
            if (score <= 4) return 'medium';
            return 'strong';
        }
        
        function updatePasswordStrength(strength) {
            const strengthDiv = document.getElementById('passwordStrength');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            strengthDiv.style.display = 'block';
            
            switch (strength) {
                case 'weak':
                    strengthBar.style.width = '33%';
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Weak password';
                    strengthText.className = 'text-danger';
                    break;
                case 'medium':
                    strengthBar.style.width = '66%';
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Medium strength password';
                    strengthText.className = 'text-warning';
                    break;
                case 'strong':
                    strengthBar.style.width = '100%';
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Strong password';
                    strengthText.className = 'text-success';
                    break;
            }
        }
        
        function showFieldError(input, errorDiv, message) {
            input.classList.add('is-invalid');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideFieldError(input, errorDiv) {
            input.classList.remove('is-invalid');
            errorDiv.style.display = 'none';
        }

        async function handleSearch(e) {
            e.preventDefault();
            const searchData = {
                source_station_id: parseInt(document.getElementById('sourceStation').value),
                destination_station_id: parseInt(document.getElementById('destinationStation').value),
                travel_date: document.getElementById('travelDate').value,
            };
            
            setLoading('search', true);

            try {
                const trains = await apiRequest('/trains/search', {
                    method: 'POST',
                    body: JSON.stringify(searchData),
                });
                
                displayTrains(trains);
            } catch (err) {
                alert('Search failed: ' + err.message);
            } finally {
                setLoading('search', false);
            }
        }

        function displayTrains(trains) {
            const resultsDiv = document.getElementById('trainResults');
            
            if (trains.length === 0) {
                resultsDiv.innerHTML = '<div class="col-12"><div class="alert alert-info">No trains found for the selected route and date.</div></div>';
                return;
            }

            resultsDiv.innerHTML = trains.map(train => `
                <div class="col-md-6 mb-3">
                    <div class="card train-card" onclick="openBookingModal(${JSON.stringify(train).replace(/"/g, '&quot;')})">
                        <div class="card-body">
                            <h5 class="card-title">${train.train.name}</h5>
                            <p class="card-text">
                                <strong>Train No:</strong> ${train.train.number}<br/>
                                <strong>Type:</strong> ${train.train.type}<br/>
                                <strong>Departure:</strong> ${train.departure_time}<br/>
                                <strong>Arrival:</strong> ${train.arrival_time}<br/>
                                <strong>Available Seats:</strong> ${train.available_seats}<br/>
                                <strong>Fare:</strong> ₹${train.base_fare}
                            </p>
                            <button class="btn btn-primary">Book Now</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openBookingModal(train) {
            selectedTrain = train;
            passengers = [{ name: '', age: '', gender: 'male' }];
            selectedPaymentMethod = null;
            selectedUpiApp = null;
            selectedCardId = null;
            selectedUpiId = null;
            selectedUpiIndex = null;
            selectedPaymentMethodType = null;
            
            // Calculate journey dates
            const journeyFrom = new Date(train.schedule_date);
            const days = Math.max(1, Math.ceil(train.route.distance_km / 500));
            const journeyTo = new Date(journeyFrom);
            journeyTo.setDate(journeyFrom.getDate() + days - 1);
            
            document.getElementById('trainDetails').innerHTML = `
                <h6>Journey Details</h6>
                <p>
                    <strong>Train:</strong> ${train.train.name} (${train.train.number})<br/>
                    <strong>Journey Dates:</strong> ${journeyFrom.toLocaleDateString()} to ${journeyTo.toLocaleDateString()}<br/>
                    <strong>From:</strong> ${train.route.source_station.name}<br/>
                    <strong>To:</strong> ${train.route.destination_station.name}<br/>
                    <strong>Distance:</strong> ${train.route.distance_km} km<br/>
                    <strong>Departure:</strong> ${train.departure_time}<br/>
                    <strong>Arrival:</strong> ${train.arrival_time}<br/>
                    <strong>Fare per person:</strong> ₹${train.base_fare}
                </p>
            `;
            
            renderPassengerForms();
            updateTotalAmount();
            loadWalletBalance();
            document.getElementById('bookingModal').classList.add('show');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('show');
            // Reset all booking data
            selectedTrain = null;
            passengers = [{ name: '', age: '', gender: 'male' }];
            selectedPaymentMethod = null;
            selectedUpiApp = null;
            selectedCardId = null;
            selectedUpiId = null;
            selectedUpiIndex = null;
            selectedPaymentMethodType = null;
            
            // Reset payment forms
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.payment-form').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.upi-app').forEach(el => el.classList.remove('selected'));
            
            // Clear form inputs
            const forms = ['cardNumber', 'cardholderName', 'expiryMonth', 'expiryYear', 'cvv', 'upiId'];
            forms.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }

        function addPassenger() {
            passengers.push({ name: '', age: '', gender: 'male' });
            renderPassengerForms();
            updateTotalAmount();
        }

        function removePassenger(index) {
            passengers.splice(index, 1);
            renderPassengerForms();
            updateTotalAmount();
        }

        function renderPassengerForms() {
            const formsDiv = document.getElementById('passengerForms');
            formsDiv.innerHTML = passengers.map((passenger, index) => `
                <div class="passenger-form">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" value="${passenger.name}" 
                                   onchange="updatePassenger(${index}, 'name', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-control" value="${passenger.age}" min="1" max="120"
                                   onchange="updatePassenger(${index}, 'age', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Gender</label>
                            <select class="form-select" onchange="updatePassenger(${index}, 'gender', this.value)">
                                <option value="male" ${passenger.gender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${passenger.gender === 'female' ? 'selected' : ''}>Female</option>
                                <option value="other" ${passenger.gender === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            ${passengers.length > 1 ? `<button class="btn btn-danger btn-sm" onclick="removePassenger(${index})">Remove</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePassenger(index, field, value) {
            if (field === 'age') {
                const age = parseInt(value);
                passengers[index][field] = isNaN(age) ? '' : age;
            } else {
                passengers[index][field] = value;
            }
        }

        function updateTotalAmount() {
            const total = selectedTrain.base_fare * passengers.length;
            document.getElementById('totalAmount').textContent = total;
        }

        async function confirmBooking() {
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }
            
            // Validate passenger details
            for (let i = 0; i < passengers.length; i++) {
                const passenger = passengers[i];
                if (!passenger.name || !passenger.name.trim()) {
                    alert(`Please enter name for passenger ${i + 1}`);
                    return;
                }
                if (!passenger.age || passenger.age === '' || isNaN(passenger.age)) {
                    alert(`Please enter a valid age for passenger ${i + 1}`);
                    return;
                }
                const age = parseInt(passenger.age);
                if (age < 1 || age > 120) {
                    alert(`Please enter a valid age (1-120) for passenger ${i + 1}`);
                    return;
                }
                if (!passenger.gender) {
                    alert(`Please select gender for passenger ${i + 1}`);
                    return;
                }
            }
            
            // Validate payment details
            const isPaymentValid = await validatePaymentDetails();
            if (!isPaymentValid) {
                return;
            }
            
            setLoading('booking', true);

            try {
                // Create booking first
                const booking = await apiRequest('/bookings/', {
                    method: 'POST',
                    body: JSON.stringify({
                        schedule_id: selectedTrain.schedule_id,
                        passengers: passengers.map(p => ({
                            name: p.name.trim(),
                            age: parseInt(p.age),
                            gender: p.gender
                        }))
                    }),
                });
                
                // Process payment
                const paymentResult = await processPayment(booking.id);
                
                if (paymentResult.status === 'success') {
                    // Store payment method type for PDF generation
                    const bookingPaymentMethods = JSON.parse(localStorage.getItem('bookingPaymentMethods') || '{}');
                    bookingPaymentMethods[booking.id] = selectedPaymentMethodType || selectedPaymentMethod;
                    localStorage.setItem('bookingPaymentMethods', JSON.stringify(bookingPaymentMethods));
                    
                    // Update wallet balance if wallet payment
                    if (selectedPaymentMethod === 'wallet') {
                        const totalAmount = selectedTrain.base_fare * passengers.length;
                        walletBalance -= totalAmount;
                        updateWalletDisplays();
                        selectedPaymentMethodType = 'Wallet';
                    }
                    
                    alert('Booking and payment successful!');
                    closeBookingModal();
                    // Reset search results to prevent showing previous booking data
                    document.getElementById('trainResults').innerHTML = '';
                    showPage('bookings');
                } else {
                    alert('Payment failed. Please try again.');
                }
            } catch (err) {
                alert('Booking failed: ' + err.message);
            } finally {
                setLoading('booking', false);
            }
        }
        
        async function validatePaymentDetails() {
            const totalAmount = selectedTrain.base_fare * passengers.length;
            
            switch(selectedPaymentMethod) {
                case 'card':
                    if (selectedCardId) {
                        const card = savedCards.find(c => c.id === selectedCardId);
                        if (!card) {
                            alert('Selected card not found. Please select another card.');
                            return false;
                        }
                        const balance = parseFloat(card.balance) || 0;
                        if (balance < totalAmount) {
                            alert(`Insufficient card balance. Available: ₹${balance.toLocaleString()}, Required: ₹${totalAmount.toLocaleString()}`);
                            return false;
                        }
                        return true;
                    } else {
                        const cardNumber = document.getElementById('cardNumber')?.value;
                        const cardholderName = document.getElementById('cardholderName')?.value;
                        const expiryMonth = document.getElementById('expiryMonth')?.value;
                        const expiryYear = document.getElementById('expiryYear')?.value;
                        const cvv = document.getElementById('cvv')?.value;
                        
                        if (!cardNumber || !cardholderName || !expiryMonth || !expiryYear || !cvv) {
                            alert('Please fill all card details or select a saved card');
                            return false;
                        }
                        
                        const cleanCardNumber = cardNumber.replace(/\s/g, '');
                        if (cleanCardNumber.length !== 16) {
                            alert('Please enter a valid 16-digit card number');
                            return false;
                        }
                        
                        if (cvv.length !== 3) {
                            alert('Please enter a valid 3-digit CVV');
                            return false;
                        }
                    }
                    break;
                    
                case 'upi':
                    if (selectedUpiId) {
                        try {
                            const upiIds = await apiRequest('/payments/upi-ids');
                            const upi = upiIds.find(u => u.upi_id === selectedUpiId);
                            if (!upi) {
                                alert('Selected UPI ID not found. Please select another UPI ID.');
                                return false;
                            }
                            const balance = parseFloat(upi.balance) || 0;
                            if (balance < totalAmount) {
                                alert(`Insufficient UPI balance. Available: ₹${balance.toLocaleString()}, Required: ₹${totalAmount.toLocaleString()}`);
                                return false;
                            }
                            return true;
                        } catch (err) {
                            alert('Failed to check UPI balance: ' + err.message);
                            return false;
                        }
                    } else {
                        if (!selectedUpiApp) {
                            alert('Please select a UPI app or choose a saved UPI ID');
                            return false;
                        }
                        
                        const upiId = document.getElementById('upiId')?.value;
                        const validUpiRegex = /^[6-9]\d{9}@(ybl|paytm|gpay)$/;
                        if (!upiId || !validUpiRegex.test(upiId)) {
                            alert('Please select a UPI app to generate valid UPI ID');
                            return false;
                        }
                    }
                    break;
                    
                case 'wallet':
                    if (walletBalance < totalAmount) {
                        alert(`Insufficient wallet balance. Available: ₹${walletBalance.toLocaleString()}, Required: ₹${totalAmount.toLocaleString()}`);
                        return false;
                    }
                    break;
                    
                default:
                    alert('Please select a payment method');
                    return false;
            }
            return true;
        }

        function selectPayment(method) {
            selectedPaymentMethod = method;
            selectedCardId = null;
            selectedUpiId = null;
            selectedPaymentMethodType = method;
            
            // Reset all forms
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.payment-form').forEach(el => el.style.display = 'none');
            
            // Select current method
            event.target.closest('.payment-method').classList.add('selected');
            
            // Show relevant form
            switch(method) {
                case 'card':
                    document.getElementById('cardPaymentForm').style.display = 'block';
                    loadSavedCardsForPayment();
                    break;
                case 'upi':
                    document.getElementById('upiPaymentForm').style.display = 'block';
                    loadSavedUpisForPayment();
                    break;
                case 'wallet':
                    document.getElementById('walletPaymentForm').style.display = 'block';
                    checkWalletBalance();
                    break;
            }
        }
        
        function selectUpiApp(app) {
            selectedUpiApp = app;
            document.querySelectorAll('.upi-app').forEach(el => el.classList.remove('selected'));
            event.target.closest('.upi-app').classList.add('selected');
            
            const upiIdField = document.getElementById('upiId');
            
            // Auto-generate UPI ID based on selected app
            const phoneNumber = '9876543210'; // Default phone number
            const upiIds = {
                'googlepay': phoneNumber + '@gpay',
                'phonepe': phoneNumber + '@ybl',
                'paytm': phoneNumber + '@paytm'
            };
            
            if (app !== 'other') {
                upiIdField.value = upiIds[app] || '';
                selectedPaymentMethodType = 'UPI';
            } else {
                upiIdField.value = '';
            }
        }
        
        async function loadWalletBalance() {
            try {
                const response = await apiRequest('/payments/wallet');
                walletBalance = parseFloat(response.balance);
                document.getElementById('walletBalance').textContent = walletBalance.toFixed(2);
                document.getElementById('currentWalletBalance').textContent = walletBalance.toFixed(2);
                if (document.getElementById('navWalletBalance')) {
                    document.getElementById('navWalletBalance').textContent = walletBalance.toFixed(2);
                }
                if (document.getElementById('profileWalletBalance')) {
                    document.getElementById('profileWalletBalance').textContent = walletBalance.toFixed(2);
                }
            } catch (err) {
                console.error('Failed to load wallet balance:', err);
                walletBalance = 0;
                document.getElementById('walletBalance').textContent = '0.00';
                document.getElementById('currentWalletBalance').textContent = '0.00';
                if (document.getElementById('navWalletBalance')) {
                    document.getElementById('navWalletBalance').textContent = '0.00';
                }
            }
        }
        
        function checkWalletBalance() {
            const totalAmount = selectedTrain.base_fare * passengers.length;
            const insufficientFunds = document.getElementById('walletInsufficientFunds');
            
            if (walletBalance < totalAmount) {
                insufficientFunds.style.display = 'block';
            } else {
                insufficientFunds.style.display = 'none';
            }
        }
        
        function setupCardNumberFormatting() {
            document.addEventListener('input', function(e) {
                if (e.target.id === 'cardNumber') {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    if (value.length > 16) value = value.substring(0, 16);
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                }
                
                if (e.target.id === 'cvv') {
                    let value = e.target.value.replace(/[^0-9]/gi, '');
                    if (value.length > 3) value = value.substring(0, 3);
                    e.target.value = value;
                }
            });
        }

        async function processPayment(bookingId) {
            const totalAmount = selectedTrain.base_fare * passengers.length;
            
            try {
                // For wallet payments, process through API
                if (selectedPaymentMethod === 'wallet') {
                    const payment = await apiRequest('/payments/process', {
                        method: 'POST',
                        body: JSON.stringify({
                            booking_id: bookingId,
                            payment_method: 'WALLET'
                        })
                    });
                    return { status: 'success', data: payment };
                }
                
                // For other payment methods, simulate processing and deduct balance
                return new Promise(async (resolve) => {
                    setTimeout(async () => {
                        let paymentData = {
                            amount: totalAmount,
                            method: selectedPaymentMethod,
                            transactionId: 'TXN' + Date.now()
                        };
                        
                        try {
                            switch(selectedPaymentMethod) {
                                case 'card':
                                    if (selectedCardId) {
                                        // Deduct from saved card balance via API
                                        await apiRequest(`/payments/credit-cards/${selectedCardId}/deduct`, {
                                            method: 'POST',
                                            body: JSON.stringify({ amount: totalAmount, description: 'Train booking payment' })
                                        });
                                        
                                        paymentData.cardId = selectedCardId;
                                        paymentData.cardLast4 = savedCards.find(c => c.id === selectedCardId)?.card_number.slice(-4);
                                    } else {
                                        paymentData.cardLast4 = document.getElementById('cardNumber').value.replace(/\s/g, '').slice(-4);
                                    }
                                    break;
                                case 'upi':
                                    if (selectedUpiId) {
                                        // Deduct from saved UPI balance via API
                                        const upiIds = await apiRequest('/payments/upi-ids');
                                        const upi = upiIds.find(u => u.upi_id === selectedUpiId);
                                        if (upi) {
                                            await apiRequest(`/payments/upi-ids/${upi.id}/deduct`, {
                                                method: 'POST',
                                                body: JSON.stringify({ amount: totalAmount, description: 'Train booking payment' })
                                            });
                                        }
                                        
                                        paymentData.upiId = selectedUpiId;
                                    } else {
                                        paymentData.upiApp = selectedUpiApp;
                                        paymentData.upiId = document.getElementById('upiId').value;
                                    }
                                    break;
                            }
                            
                            // Simulate success (95% success rate)
                            const success = Math.random() > 0.05;
                            resolve({ 
                                status: success ? 'success' : 'failed', 
                                data: paymentData 
                            });
                        } catch (err) {
                            resolve({ status: 'failed', error: err.message });
                        }
                    }, 2000);
                });
            } catch (err) {
                return { status: 'failed', error: err.message };
            }
        }

        // Chat functions
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('show');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            try {
                const response = await getChatResponse(message);
                addMessage(response, 'bot');
            } catch (err) {
                addMessage('Sorry, I\'m having trouble responding right now. Please try again later.', 'bot');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function getChatResponse(message) {
            if (PERPLEXITY_API_KEY === 'YOUR_PERPLEXITY_API_KEY') {
                // Fallback responses when API key is not set
                const responses = {
                    'hello': 'Hello! How can I help you with your railway booking?',
                    'booking': 'You can search for trains, select your preferred train, and book tickets easily.',
                    'payment': 'We accept credit/debit cards, UPI, and digital wallets for payments.',
                    'cancel': 'You can cancel your booking from the "My Bookings" section.',
                    'help': 'I can help you with train bookings, payments, cancellations, and general railway information.'
                };
                
                const lowerMessage = message.toLowerCase();
                for (const [key, response] of Object.entries(responses)) {
                    if (lowerMessage.includes(key)) {
                        return response;
                    }
                }
                return 'I can help you with train bookings, payments, and general railway information. What would you like to know?';
            }
            
            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${PERPLEXITY_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-sonar-small-128k-online',
                        messages: [{
                            role: 'system',
                            content: 'You are a helpful railway booking assistant. Provide concise, helpful answers about train bookings, payments, and railway services.'
                        }, {
                            role: 'user',
                            content: message
                        }],
                        max_tokens: 150
                    })
                });
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (err) {
                throw new Error('Failed to get response from chat service');
            }
        }

        async function loadBookings() {
            try {
                const bookings = await apiRequest('/bookings/');
                displayBookings(bookings);
            } catch (err) {
                console.error('Failed to load bookings:', err);
            }
        }

        function displayBookings(bookings) {
            const bookingsDiv = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                bookingsDiv.innerHTML = `
                    <div class="text-center">
                        <p>No bookings found.</p>
                        <button class="btn btn-primary" onclick="showPage('search')">Search Trains</button>
                    </div>
                `;
                return;
            }

            bookingsDiv.innerHTML = `
                <div class="row">
                    ${bookings.map(booking => `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        ${booking.schedule.route.train.name}
                                        <span class="badge ms-2 ${getStatusBadgeClass(booking.status)}">${booking.status}</span>
                                    </h5>
                                    <p class="card-text">
                                        <strong>Booking Reference:</strong> ${booking.booking_reference}<br/>
                                        <strong>Train No:</strong> ${booking.schedule.route.train.number}<br/>
                                        <strong>Journey Dates:</strong> ${booking.journey_date_from} to ${booking.journey_date_to}<br/>
                                        <strong>From:</strong> ${booking.schedule.route.source_station.name}<br/>
                                        <strong>To:</strong> ${booking.schedule.route.destination_station.name}<br/>
                                        <strong>Passengers:</strong> ${booking.passenger_count}<br/>
                                        <strong>Total Amount:</strong> ₹${booking.total_amount}
                                    </p>
                                    
                                    <div class="mt-3">
                                        <h6>Passengers:</h6>
                                        ${booking.passengers.map(passenger => 
                                            `<small class="d-block">${passenger.name} (${passenger.age}yrs, ${passenger.gender})</small>`
                                        ).join('')}
                                    </div>

                                    ${booking.status === 'confirmed' ? 
                                        `<div class="mt-3">
                                            <button class="btn btn-warning btn-sm me-2" onclick="editBooking(${booking.id})">Edit</button>
                                            <button class="btn btn-danger btn-sm me-2" onclick="cancelBooking(${booking.id})">Cancel & Refund</button>
                                            <button class="btn btn-success btn-sm" onclick="generatePDF(${booking.id})">Generate PDF</button>
                                        </div>` : 
                                        booking.status === 'cancelled' ?
                                        `<div class="mt-3">
                                            <div class="alert alert-warning">
                                                <small>Booking cancelled. Refund request submitted for admin approval.</small>
                                            </div>
                                            <button class="btn btn-success btn-sm" onclick="generatePDF(${booking.id})">Generate PDF</button>
                                        </div>` :
                                        `<div class="mt-3">
                                            <button class="btn btn-success btn-sm" onclick="generatePDF(${booking.id})">Generate PDF</button>
                                        </div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'confirmed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        async function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking? A refund request will be submitted for admin approval.')) {
                try {
                    const response = await apiRequest(`/bookings/${bookingId}/cancel`, { method: 'PUT' });
                    alert(`Booking cancelled successfully! Refund request for ₹${response.refund_amount} has been submitted for admin approval.`);
                    loadBookings();
                } catch (err) {
                    alert('Failed to cancel booking: ' + err.message);
                }
            }
        }

        async function generatePDF(bookingId) {
            try {
                const booking = await apiRequest(`/bookings/${bookingId}`);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(20);
                doc.text('Railway Ticket', 105, 20, { align: 'center' });
                
                // Booking details
                doc.setFontSize(12);
                let y = 40;
                doc.text(`Booking Reference: ${booking.booking_reference}`, 20, y);
                y += 10;
                doc.text(`Train: ${booking.schedule.route.train.name} (${booking.schedule.route.train.number})`, 20, y);
                y += 10;
                doc.text(`From: ${booking.schedule.route.source_station.name}`, 20, y);
                y += 10;
                doc.text(`To: ${booking.schedule.route.destination_station.name}`, 20, y);
                y += 10;
                doc.text(`Journey Dates: ${booking.journey_date_from} to ${booking.journey_date_to}`, 20, y);
                y += 10;
                doc.text(`Total Amount: ₹${booking.total_amount}`, 20, y);
                y += 10;
                doc.text(`Status: ${booking.status}`, 20, y);
                y += 20;
                
                // Passengers
                doc.text('Passengers:', 20, y);
                y += 10;
                booking.passengers.forEach(passenger => {
                    doc.text(`${passenger.name} (${passenger.age}yrs, ${passenger.gender})`, 30, y);
                    y += 10;
                });
                
                // Save the PDF
                doc.save(`ticket_${booking.booking_reference}.pdf`);
            } catch (err) {
                alert('Failed to generate PDF: ' + err.message);
            }
        }
        
        function editBooking(bookingId) {
            apiRequest(`/bookings/${bookingId}`).then(booking => {
                document.getElementById('editBookingDetails').innerHTML = `
                    <h6>Edit Booking: ${booking.booking_reference}</h6>
                    <p><strong>Train:</strong> ${booking.schedule.route.train.name}</p>
                `;
                
                const editFormsDiv = document.getElementById('editPassengerForms');
                editFormsDiv.innerHTML = booking.passengers.map((passenger, index) => `
                    <div class="passenger-form">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" value="${passenger.name}" id="editName${index}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-control" value="${passenger.age}" id="editAge${index}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="editGender${index}">
                                    <option value="male" ${passenger.gender === 'male' ? 'selected' : ''}>Male</option>
                                    <option value="female" ${passenger.gender === 'female' ? 'selected' : ''}>Female</option>
                                    <option value="other" ${passenger.gender === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('editBookingModal').classList.add('show');
                window.currentEditBookingId = bookingId;
                window.currentEditPassengerCount = booking.passengers.length;
            });
        }
        
        function closeEditBookingModal() {
            document.getElementById('editBookingModal').classList.remove('show');
        }
        
        async function saveBookingChanges() {
            const updatedPassengers = [];
            for (let i = 0; i < window.currentEditPassengerCount; i++) {
                updatedPassengers.push({
                    name: document.getElementById(`editName${i}`).value,
                    age: parseInt(document.getElementById(`editAge${i}`).value),
                    gender: document.getElementById(`editGender${i}`).value
                });
            }
            
            setLoading('editBooking', true);
            
            try {
                await apiRequest(`/bookings/${window.currentEditBookingId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ passengers: updatedPassengers })
                });
                
                alert('Booking updated successfully!');
                closeEditBookingModal();
                loadBookings();
            } catch (err) {
                alert('Failed to update booking: ' + err.message);
            } finally {
                setLoading('editBooking', false);
            }
        }
        
        async function loadProfile() {
            if (!currentUser) return;
            
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone || 'Not provided';
            document.getElementById('profileFullName').textContent = currentUser.full_name;
            document.getElementById('profileUsernameDetail').textContent = currentUser.username;
            document.getElementById('profileEmailDetail').textContent = currentUser.email;
            document.getElementById('profilePhoneDetail').textContent = currentUser.phone || 'Not provided';
            document.getElementById('profileMemberSince').textContent = new Date(currentUser.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            
            await loadWalletBalance();
            document.getElementById('profileWalletBalance').textContent = walletBalance.toFixed(2);
            
            // Load saved payment methods
            await loadSavedPaymentMethods();
            
            try {
                const transactions = await apiRequest('/payments/wallet/transactions');
                const transactionsDiv = document.getElementById('profileTransactions');
                
                if (transactions.length === 0) {
                    transactionsDiv.innerHTML = '<p class="text-muted">No transactions found.</p>';
                } else {
                    transactionsDiv.innerHTML = transactions.slice(0, 10).map(tx => `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                            <div>
                                <small class="fw-bold">${tx.description}</small><br>
                                <small class="text-muted">${new Date(tx.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="text-${tx.transaction_type === 'credit' ? 'success' : 'danger'} fw-bold">
                                ${tx.transaction_type === 'credit' ? '+' : '-'}₹${tx.amount}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load transactions:', err);
            }
        }

        function updateWalletDisplays() {
            const balance = walletBalance.toFixed(2);
            const elements = ['walletBalance', 'currentWalletBalance', 'modalWalletBalance', 'navWalletBalance', 'profileWalletBalance'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = balance;
            });
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            walletBalance = 0;
            savedCards = [];
            updateNavbar();
            showPage('home');
            console.log('User logged out successfully');
        }

        function setLoading(type, loading) {
            const btnText = document.getElementById(`${type}BtnText`);
            const spinner = document.getElementById(`${type}Spinner`);
            const btn = btnText.closest('button');
            
            if (loading) {
                btnText.style.display = 'none';
                spinner.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function showBanPopup() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-ban me-2"></i>
                                Account Temporarily Banned
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-3">
                                <i class="fas fa-user-slash fa-4x text-danger mb-3"></i>
                            </div>
                            <h6 class="text-danger mb-3">Your account has been temporarily blocked</h6>
                            <p class="mb-3">Your account access has been restricted by an administrator. This is a temporary measure.</p>
                            <div class="alert alert-info">
                                <strong>What to do next:</strong><br>
                                Please contact the system administrator to resolve this issue and restore your account access.
                            </div>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-primary" onclick="closeBanPopup()">I Understand</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentBanModal = modal;
        }
        
        function closeBanPopup() {
            if (window.currentBanModal) {
                window.currentBanModal.remove();
                window.currentBanModal = null;
            }
            showPage('home');
        }

        async function loadAdminDashboard() {
            try {
                const dashboard = await apiRequest('/trains/admin/dashboard');
                
                document.getElementById('totalTrains').textContent = dashboard.total_trains;
                document.getElementById('totalBookings').textContent = dashboard.total_bookings;
                document.getElementById('totalRevenue').textContent = '₹' + dashboard.total_revenue;
                document.getElementById('activeUsers').textContent = dashboard.active_users || 0;
                
                displayRecentBookings(dashboard.recent_bookings);
                loadSystemAlerts();
            } catch (err) {
                console.error('Failed to load admin dashboard:', err);
            }
        }
        
        async function loadSystemAlerts() {
            try {
                const alertsDiv = document.getElementById('systemAlerts');
                
                // Load real system alerts from API
                const alerts = await apiRequest('/admin/system-alerts');
                
                if (alerts.length === 0) {
                    alertsDiv.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            All systems operational
                        </div>
                    `;
                } else {
                    alertsDiv.innerHTML = alerts.map(alert => `
                        <div class="alert alert-${alert.type} mb-2 d-flex justify-content-between align-items-start">
                            <div>
                                <i class="fas fa-${alert.icon} me-2"></i>
                                <strong>${alert.title}</strong><br>
                                <small>${alert.message}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${alert.time}</small>
                                ${alert.dismissible ? `<button class="btn btn-sm btn-link p-0 ms-2" onclick="dismissAlert('${alert.id}')" title="Dismiss"><i class="fas fa-times"></i></button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load system alerts:', err);
                document.getElementById('systemAlerts').innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load system alerts
                    </div>
                `;
            }
        }
        
        async function refreshSystemAlerts() {
            const alertsDiv = document.getElementById('systemAlerts');
            alertsDiv.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            // Add a small delay to show loading state
            setTimeout(() => {
                loadSystemAlerts();
            }, 1000);
        }
        
        async function dismissAlert(alertId) {
            try {
                await apiRequest(`/admin/system-alerts/${alertId}/dismiss`, { method: 'POST' });
                
                // Remove the alert from UI
                const alertElement = event.target.closest('.alert');
                if (alertElement) {
                    alertElement.style.transition = 'opacity 0.3s ease';
                    alertElement.style.opacity = '0';
                    setTimeout(() => {
                        alertElement.remove();
                        // Check if no alerts remain
                        const remainingAlerts = document.querySelectorAll('#systemAlerts .alert');
                        if (remainingAlerts.length === 0) {
                            document.getElementById('systemAlerts').innerHTML = `
                                <div class="alert alert-success mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    All systems operational
                                </div>
                            `;
                        }
                    }, 300);
                }
            } catch (err) {
                console.error('Failed to dismiss alert:', err);
                alert('Failed to dismiss alert: ' + err.message);
            }
        }
        // Admin tab switching
        document.addEventListener('click', function(e) {
            if (e.target.matches('.nav-tabs .nav-link')) {
                const tab = e.target.getAttribute('data-tab');
                switchAdminTab(tab);
            }
        });
        
        function switchAdminTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(`admin-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked nav link
            const activeLink = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadAdminDashboard();
                    break;
                case 'trains':
                    loadTrainsManagement();
                    break;
                case 'routes':
                    loadRoutesManagement();
                    break;
                case 'bookings':
                    loadBookingsOversight();
                    break;
                case 'users':
                    loadUsersManagement();
                    break;
                case 'reports':
                    loadReportsAnalytics();
                    break;
                case 'refunds':
                    loadRefundRequests();
                    break;
            }
        }
        
        async function loadTrainsManagement() {
            try {
                const trains = await apiRequest('/trains/');
                const trainsDiv = document.getElementById('trainsList');
                
                trainsDiv.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Train Number</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Total Seats</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trains.map(train => `
                                    <tr>
                                        <td>${train.number}</td>
                                        <td>${train.name}</td>
                                        <td><span class="badge bg-info">${train.type}</span></td>
                                        <td>${train.total_seats}</td>
                                        <td><span class="badge ${train.is_active ? 'bg-success' : 'bg-danger'}">${train.is_active ? 'Active' : 'Inactive'}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-warning me-1" onclick="editTrain(${train.id})">Edit</button>
                                            <button class="btn btn-xs ${train.is_active ? 'btn-secondary' : 'btn-success'} me-1" onclick="toggleTrainStatus(${train.id}, ${train.is_active})" style="font-size: 10px; padding: 2px 6px;">
                                                ${train.is_active ? 'Deactivate' : 'Activate'}
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteTrain(${train.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load trains:', err);
                document.getElementById('trainsList').innerHTML = '<p class="text-danger">Failed to load trains data</p>';
            }
        }
        
        function editTrain(trainId) {
            apiRequest(`/trains/${trainId}`).then(train => {
                document.getElementById('editTrainNumber').value = train.number;
                document.getElementById('editTrainName').value = train.name;
                document.getElementById('editTrainType').value = train.type;
                document.getElementById('editTotalSeats').value = train.total_seats;
                
                window.currentEditTrainId = trainId;
                document.getElementById('editTrainModal').classList.add('show');
            }).catch(err => {
                alert('Failed to load train details: ' + err.message);
            });
        }
        
        function closeEditTrainModal() {
            document.getElementById('editTrainModal').classList.remove('show');
            document.getElementById('editTrainForm').reset();
        }
        
        async function saveTrainChanges() {
            const trainData = {
                number: document.getElementById('editTrainNumber').value,
                name: document.getElementById('editTrainName').value,
                type: document.getElementById('editTrainType').value,
                total_seats: parseInt(document.getElementById('editTotalSeats').value)
            };
            
            try {
                await apiRequest(`/trains/${window.currentEditTrainId}`, {
                    method: 'PUT',
                    body: JSON.stringify(trainData)
                });
                
                alert('Train updated successfully!');
                closeEditTrainModal();
                loadTrainsManagement();
            } catch (err) {
                alert('Failed to update train: ' + err.message);
            }
        }
        
        async function loadBookingsOversight() {
            try {
                const bookings = await apiRequest('/bookings/');
                const bookingsDiv = document.getElementById('allBookings');
                
                bookingsDiv.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Booking Ref</th>
                                    <th>Train</th>
                                    <th>Date</th>
                                    <th>Passengers</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bookings.map(booking => `
                                    <tr>
                                        <td>${booking.booking_reference}</td>
                                        <td>${booking.schedule?.route?.train?.name || 'N/A'}</td>
                                        <td>${booking.schedule?.schedule_date || 'N/A'}</td>
                                        <td>${booking.passenger_count}</td>
                                        <td>₹${booking.total_amount}</td>
                                        <td><span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="viewBookingDetails(${booking.id})">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load bookings:', err);
                document.getElementById('allBookings').innerHTML = '<p class="text-danger">Failed to load bookings data</p>';
            }
        }
        
        async function loadUsersManagement() {
            try {
                const users = await apiRequest('/admin/users');
                const usersDiv = document.getElementById('usersList');
                
                usersDiv.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.id}</td>
                                        <td>${user.username}</td>
                                        <td>${user.full_name}</td>
                                        <td>${user.email}</td>
                                        <td><span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                                        <td><span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">${user.is_active ? 'Active' : 'Blocked'}</span></td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td>
                                            ${user.role !== 'admin' ? `
                                                <button class="btn btn-xs ${user.is_active ? 'btn-warning' : 'btn-success'} me-1" onclick="toggleUserStatus(${user.id}, ${user.is_active})" style="font-size: 10px; padding: 2px 6px;">
                                                    ${user.is_active ? 'Block' : 'Unblock'}
                                                </button>
                                            ` : '<span class="text-muted">Admin</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load users:', err);
                document.getElementById('usersList').innerHTML = '<p class="text-danger">Failed to load users data</p>';
            }
        }
        
        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'block' : 'unblock';
            if (confirm(`Are you sure you want to ${action} this user?`)) {
                try {
                    await apiRequest(`/admin/users/${userId}/toggle-status`, { method: 'PATCH' });
                    alert(`User ${action}ed successfully!`);
                    loadUsersManagement();
                } catch (err) {
                    alert(`Failed to ${action} user: ` + err.message);
                }
            }
        }
        
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to permanently delete this user? This action cannot be undone.')) {
                try {
                    await apiRequest(`/admin/users/${userId}`, { method: 'DELETE' });
                    alert('User deleted successfully!');
                    loadUsersManagement();
                } catch (err) {
                    alert('Failed to delete user: ' + err.message);
                }
            }
        }
        
        async function loadRoutesManagement() {
            try {
                const routes = await apiRequest('/routes/');
                const routesDiv = document.getElementById('routesList');
                
                routesDiv.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Train</th>
                                    <th>Source</th>
                                    <th>Destination</th>
                                    <th>Departure</th>
                                    <th>Arrival</th>
                                    <th>Distance</th>
                                    <th>Fare</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${routes.map(route => `
                                    <tr>
                                        <td>${route.id}</td>
                                        <td>${route.train?.name || 'N/A'}</td>
                                        <td>${route.source_station?.name || 'N/A'}</td>
                                        <td>${route.destination_station?.name || 'N/A'}</td>
                                        <td>${route.departure_time}</td>
                                        <td>${route.arrival_time}</td>
                                        <td>${route.distance_km} km</td>
                                        <td>₹${route.base_fare}</td>
                                        <td><span class="badge ${route.is_active ? 'bg-success' : 'bg-danger'}">${route.is_active ? 'Active' : 'Inactive'}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-success me-1" onclick="createSchedulesForRoute(${route.id})">Create Schedules</button>
                                            <button class="btn btn-sm btn-warning me-1" onclick="editRoute(${route.id})">Edit</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRoute(${route.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load routes:', err);
                document.getElementById('routesList').innerHTML = '<p class="text-danger">Failed to load routes data</p>';
            }
        }
        
        function showAddRouteForm() {
            loadTrainsAndStations();
            document.getElementById('addRouteModal').classList.add('show');
        }
        
        function closeAddRouteModal() {
            document.getElementById('addRouteModal').classList.remove('show');
            document.getElementById('addRouteForm').reset();
        }
        
        async function loadTrainsAndStations() {
            try {
                const [trains, stations] = await Promise.all([
                    apiRequest('/trains/'),
                    apiRequest('/stations/')
                ]);
                
                // Populate train dropdowns
                const trainSelects = ['routeTrainId', 'editRouteTrainId'];
                trainSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Train</option>' + 
                            trains.map(train => `<option value="${train.id}">${train.name} (${train.number})</option>`).join('');
                    }
                });
                
                // Populate station dropdowns
                const stationSelects = ['routeSourceStation', 'routeDestinationStation', 'editRouteSourceStation', 'editRouteDestinationStation'];
                stationSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select Station</option>' + 
                            stations.map(station => `<option value="${station.id}">${station.name} (${station.code})</option>`).join('');
                    }
                });
            } catch (err) {
                console.error('Failed to load trains and stations:', err);
            }
        }
        
        async function addRoute() {
            const routeData = {
                train_id: parseInt(document.getElementById('routeTrainId').value),
                source_station_id: parseInt(document.getElementById('routeSourceStation').value),
                destination_station_id: parseInt(document.getElementById('routeDestinationStation').value),
                departure_time: document.getElementById('routeDepartureTime').value,
                arrival_time: document.getElementById('routeArrivalTime').value,
                distance_km: parseInt(document.getElementById('routeDistance').value),
                base_fare: parseFloat(document.getElementById('routeBaseFare').value)
            };
            
            if (routeData.source_station_id === routeData.destination_station_id) {
                alert('Source and destination stations cannot be the same');
                return;
            }
            
            try {
                await apiRequest('/routes/', {
                    method: 'POST',
                    body: JSON.stringify(routeData)
                });
                
                alert('Route added successfully!');
                closeAddRouteModal();
                loadRoutesManagement();
            } catch (err) {
                alert('Failed to add route: ' + err.message);
            }
        }
        
        async function editRoute(routeId) {
            try {
                const route = await apiRequest(`/routes/${routeId}`);
                await loadTrainsAndStations();
                
                document.getElementById('editRouteTrainId').value = route.train_id;
                document.getElementById('editRouteSourceStation').value = route.source_station_id;
                document.getElementById('editRouteDestinationStation').value = route.destination_station_id;
                document.getElementById('editRouteDepartureTime').value = route.departure_time;
                document.getElementById('editRouteArrivalTime').value = route.arrival_time;
                document.getElementById('editRouteDistance').value = route.distance_km;
                document.getElementById('editRouteBaseFare').value = route.base_fare;
                
                window.currentEditRouteId = routeId;
                document.getElementById('editRouteModal').classList.add('show');
            } catch (err) {
                alert('Failed to load route details: ' + err.message);
            }
        }
        
        function closeEditRouteModal() {
            document.getElementById('editRouteModal').classList.remove('show');
            document.getElementById('editRouteForm').reset();
        }
        
        async function saveRouteChanges() {
            const routeData = {
                train_id: parseInt(document.getElementById('editRouteTrainId').value),
                source_station_id: parseInt(document.getElementById('editRouteSourceStation').value),
                destination_station_id: parseInt(document.getElementById('editRouteDestinationStation').value),
                departure_time: document.getElementById('editRouteDepartureTime').value,
                arrival_time: document.getElementById('editRouteArrivalTime').value,
                distance_km: parseInt(document.getElementById('editRouteDistance').value),
                base_fare: parseFloat(document.getElementById('editRouteBaseFare').value)
            };
            
            if (routeData.source_station_id === routeData.destination_station_id) {
                alert('Source and destination stations cannot be the same');
                return;
            }
            
            try {
                await apiRequest(`/routes/${window.currentEditRouteId}`, {
                    method: 'PUT',
                    body: JSON.stringify(routeData)
                });
                
                alert('Route updated successfully!');
                closeEditRouteModal();
                loadRoutesManagement();
            } catch (err) {
                alert('Failed to update route: ' + err.message);
            }
        }
        
        async function loadRoutesForStations() {
            const sourceId = document.getElementById('sourceStation').value;
            const destId = document.getElementById('destinationStation').value;
            const routeInfo = document.getElementById('routeInfo');
            
            if (!sourceId || !destId) {
                routeInfo.style.display = 'none';
                return;
            }
            
            try {
                const routes = await apiRequest('/routes/');
                const matchingRoutes = routes.filter(route => 
                    route.source_station_id == sourceId && route.destination_station_id == destId
                );
                
                if (matchingRoutes.length > 0) {
                    const route = matchingRoutes[0];
                    routeInfo.innerHTML = `
                        <strong>Route Available:</strong> ${route.train.name} (${route.train.number})<br>
                        <strong>Departure:</strong> ${route.departure_time} | <strong>Arrival:</strong> ${route.arrival_time}<br>
                        <strong>Distance:</strong> ${route.distance_km} km | <strong>Fare:</strong> ₹${route.base_fare}
                    `;
                    routeInfo.className = 'alert alert-success';
                } else {
                    routeInfo.innerHTML = `
                        <strong>No direct routes found</strong> between selected stations.<br>
                        <small>Please contact admin to add routes for this route.</small>
                    `;
                    routeInfo.className = 'alert alert-warning';
                }
                routeInfo.style.display = 'block';
            } catch (err) {
                console.error('Failed to load routes:', err);
                routeInfo.style.display = 'none';
            }
        }
        
        async function bulkCreateSchedules() {
            if (confirm('This will create train schedules for all routes for the next 30 days. Continue?')) {
                try {
                    const response = await apiRequest('/routes/bulk-create-schedules', { method: 'POST' });
                    alert(response.message);
                    loadRoutesManagement();
                } catch (err) {
                    alert('Failed to create schedules: ' + err.message);
                }
            }
        }
        
        async function createSchedulesForRoute(routeId) {
            if (confirm('This will create schedules for this route for the next 30 days. Continue?')) {
                try {
                    const response = await apiRequest(`/routes/${routeId}/create-schedules`, { method: 'POST' });
                    alert(response.message);
                } catch (err) {
                    alert('Failed to create schedules: ' + err.message);
                }
            }
        }
        
        async function deleteRoute(routeId) {
            if (confirm('Are you sure you want to delete this route?')) {
                try {
                    await apiRequest(`/routes/${routeId}`, { method: 'DELETE' });
                    alert('Route deleted successfully!');
                    loadRoutesManagement();
                } catch (err) {
                    alert('Failed to delete route: ' + err.message);
                }
            }
        }
        
        function loadReportsAnalytics() {
            // Generate sample revenue data
            const revenueData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Revenue (₹)',
                    data: [50000, 75000, 60000, 90000, 85000, 100000],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                }]
            };
            
            // Generate sample booking data
            const bookingData = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Bookings',
                    data: [120, 190, 150, 220],
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                }]
            };
            
            // Create revenue chart
            const revenueCanvas = document.getElementById('revenueChart');
            if (revenueCanvas) {
                const ctx = revenueCanvas.getContext('2d');
                ctx.clearRect(0, 0, revenueCanvas.width, revenueCanvas.height);
                
                // Simple line chart implementation
                const padding = 40;
                const chartWidth = revenueCanvas.width - 2 * padding;
                const chartHeight = revenueCanvas.height - 2 * padding;
                
                // Draw axes
                ctx.strokeStyle = '#ccc';
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, revenueCanvas.height - padding);
                ctx.lineTo(revenueCanvas.width - padding, revenueCanvas.height - padding);
                ctx.stroke();
                
                // Draw line
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.beginPath();
                const data = revenueData.datasets[0].data;
                const maxValue = Math.max(...data);
                
                data.forEach((value, index) => {
                    const x = padding + (index * chartWidth) / (data.length - 1);
                    const y = revenueCanvas.height - padding - (value / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw points
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
                ctx.stroke();
                
                // Draw labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                revenueData.labels.forEach((label, index) => {
                    const x = padding + (index * chartWidth) / (revenueData.labels.length - 1);
                    ctx.fillText(label, x, revenueCanvas.height - 10);
                });
            }
            
            // Create booking chart
            const bookingCanvas = document.getElementById('bookingChart');
            if (bookingCanvas) {
                const ctx = bookingCanvas.getContext('2d');
                ctx.clearRect(0, 0, bookingCanvas.width, bookingCanvas.height);
                
                // Simple bar chart implementation
                const padding = 40;
                const chartWidth = bookingCanvas.width - 2 * padding;
                const chartHeight = bookingCanvas.height - 2 * padding;
                const barWidth = chartWidth / bookingData.labels.length * 0.6;
                const maxValue = Math.max(...bookingData.datasets[0].data);
                
                bookingData.datasets[0].data.forEach((value, index) => {
                    const x = padding + (index * chartWidth) / bookingData.labels.length + chartWidth / bookingData.labels.length * 0.2;
                    const barHeight = (value / maxValue) * chartHeight;
                    const y = bookingCanvas.height - padding - barHeight;
                    
                    // Draw bar
                    ctx.fillStyle = bookingData.datasets[0].backgroundColor[index];
                    ctx.fillRect(x, y, barWidth, barHeight);
                    
                    // Draw value on top
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(value, x + barWidth / 2, y - 5);
                    
                    // Draw label
                    ctx.fillText(bookingData.labels[index], x + barWidth / 2, bookingCanvas.height - 10);
                });
            }
        }

        async function loadRefundRequests() {
            // Check if user is admin
            if (!currentUser || currentUser.role !== 'admin') {
                document.getElementById('refundRequestsList').innerHTML = '<div class="alert alert-danger">Access denied. Admin privileges required.</div>';
                return;
            }
            
            try {
                const refundRequests = await apiRequest('/admin/refund-requests');
                displayRefundRequests(refundRequests);
            } catch (err) {
                console.error('Failed to load refund requests:', err);
                document.getElementById('refundRequestsList').innerHTML = '<div class="alert alert-danger">Failed to load refund requests. Please check your admin privileges and try again.</div>';
            }
        }

        function displayRefundRequests(requests) {
            const requestsDiv = document.getElementById('refundRequestsList');
            
            if (requests.length === 0) {
                requestsDiv.innerHTML = '<div class="alert alert-info">No pending refund requests.</div>';
                return;
            }

            requestsDiv.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Booking Ref</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Requested</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(request => `
                                <tr>
                                    <td>${request.booking.booking_reference}</td>
                                    <td>${request.user.full_name} (${request.user.email})</td>
                                    <td>₹${request.amount}</td>
                                    <td>${new Date(request.requested_at).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-success btn-sm me-2" onclick="approveRefund(${request.id})">Approve</button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectRefund(${request.id})">Reject</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function approveRefund(requestId) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            if (confirm('Are you sure you want to approve this refund request?')) {
                try {
                    await apiRequest(`/admin/refund-requests/${requestId}/approve`, { method: 'PUT' });
                    alert('Refund request approved and processed successfully.');
                    loadRefundRequests();
                } catch (err) {
                    alert('Failed to approve refund: ' + err.message);
                }
            }
        }

        async function rejectRefund(requestId) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const reason = prompt('Please provide a reason for rejection:');
            if (reason !== null) {
                try {
                    await apiRequest(`/admin/refund-requests/${requestId}/reject`, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            status: 'rejected',
                            rejection_reason: reason 
                        })
                    });
                    alert('Refund request rejected.');
                    loadRefundRequests();
                } catch (err) {
                    alert('Failed to reject refund: ' + err.message);
                }
            }
        }

        function displayTrainsList(dashboard) {
            const trainsDiv = document.getElementById('trainsList');
            
            apiRequest('/trains/').then(trains => {
                trainsDiv.innerHTML = trains.map(train => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${train.name}</strong><br>
                            <small>${train.number} - ${train.type} (${train.total_seats} seats)</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteTrain(${train.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            });
        }

        function displayRecentBookings(bookings) {
            const bookingsDiv = document.getElementById('recentBookings');
            
            bookingsDiv.innerHTML = bookings.map(booking => `
                <div class="mb-2 p-2 border rounded">
                    <strong>Ref: ${booking.booking_reference}</strong><br>
                    <small>Amount: ₹${booking.total_amount} | Status: ${booking.status}</small>
                </div>
            `).join('');
        }

        function showAddTrainForm() {
            document.getElementById('addTrainModal').classList.add('show');
        }

        function closeAddTrainModal() {
            document.getElementById('addTrainModal').classList.remove('show');
            document.getElementById('addTrainForm').reset();
        }

        async function addTrain() {
            const trainData = {
                number: document.getElementById('trainNumber').value,
                name: document.getElementById('trainName').value,
                type: document.getElementById('trainType').value,
                total_seats: parseInt(document.getElementById('totalSeats').value)
            };

            try {
                await apiRequest('/trains/', {
                    method: 'POST',
                    body: JSON.stringify(trainData)
                });
                
                alert('Train added successfully!');
                closeAddTrainModal();
                loadTrainsManagement();
            } catch (err) {
                alert('Failed to add train: ' + err.message);
            }
        }

        async function toggleTrainStatus(trainId, currentStatus) {
            const action = currentStatus ? 'deactivate' : 'activate';
            if (confirm(`Are you sure you want to ${action} this train?`)) {
                try {
                    await apiRequest(`/trains/${trainId}/toggle-status`, { method: 'PATCH' });
                    alert(`Train ${action}d successfully!`);
                    loadTrainsManagement();
                } catch (err) {
                    alert(`Failed to ${action} train: ` + err.message);
                }
            }
        }
        
        async function syncRoutesWithTrains() {
            if (confirm('This will sync all routes with their train status. Continue?')) {
                try {
                    await apiRequest('/trains/sync-routes', { method: 'PATCH' });
                    alert('Routes synced successfully!');
                    loadRoutesManagement();
                } catch (err) {
                    alert('Failed to sync routes: ' + err.message);
                }
            }
        }
        
        async function deleteTrain(trainId) {
            if (confirm('Are you sure you want to delete this train?')) {
                try {
                    await apiRequest(`/trains/${trainId}`, { method: 'DELETE' });
                    alert('Train deleted successfully!');
                    loadTrainsManagement();
                } catch (err) {
                    alert('Failed to delete train: ' + err.message);
                }
            }
        }
        
        async function loadSavedPaymentMethods() {
            try {
                // Try to load saved credit cards with balances
                let cards = [];
                try {
                    cards = await apiRequest('/payments/credit-cards');
                    savedCards = cards; // Store globally for booking use
                } catch (err) {
                    console.warn('Credit cards API not available:', err.message);
                    cards = [];
                }
                
                const cardsDiv = document.getElementById('savedCards');
                if (cardsDiv) {
                    if (cards.length === 0) {
                        cardsDiv.innerHTML = '<p class="text-muted small">No saved cards</p>';
                    } else {
                        cardsDiv.innerHTML = cards.map(card => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <small class="fw-bold">**** **** **** ${card.card_number.slice(-4)}</small><br>
                                    <small class="text-muted">${card.cardholder_name}</small><br>
                                    <small class="text-success">Balance: ₹${(card.balance || 0).toLocaleString()}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="showCardTransactions(${card.id})">Transactions</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCard(${card.id})">Remove</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Try to load UPI IDs with balances
                let upiIds = [];
                try {
                    upiIds = await apiRequest('/payments/upi-ids');
                } catch (err) {
                    console.warn('UPI IDs API not available:', err.message);
                    upiIds = [];
                }
                
                const upiDiv = document.getElementById('savedUpiIds');
                if (upiDiv) {
                    if (upiIds.length === 0) {
                        upiDiv.innerHTML = '<p class="text-muted small">No saved UPI IDs</p>';
                    } else {
                        upiDiv.innerHTML = upiIds.map(upi => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <small class="fw-bold">****${upi.upi_id.split('@')[0].slice(-4)}@${upi.upi_id.split('@')[1]}</small><br>
                                    <small class="text-success">Balance: ₹${(upi.balance || 0).toLocaleString()}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="showUpiTransactions(${upi.id})">Transactions</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUpiId(${upi.id})">Remove</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                console.error('Failed to load payment methods:', err);
                const cardsDiv = document.getElementById('savedCards');
                const upiDiv = document.getElementById('savedUpiIds');
                
                if (cardsDiv) {
                    cardsDiv.innerHTML = `<p class="text-warning small">Payment methods unavailable. Backend API may not be running.</p>`;
                }
                if (upiDiv) {
                    upiDiv.innerHTML = `<p class="text-warning small">UPI payment unavailable. Backend API may not be running.</p>`;
                }
            }
        }
        
        function showAddCardModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Credit Card</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="newCardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cardholder Name</label>
                                <input type="text" class="form-control" id="newCardholderName" placeholder="John Doe">
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Expiry Month</label>
                                    <select class="form-select" id="newExpiryMonth">
                                        <option value="">MM</option>
                                        ${Array.from({length: 12}, (_, i) => i + 1).map(m => 
                                            `<option value="${m.toString().padStart(2, '0')}">${m.toString().padStart(2, '0')}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Expiry Year</label>
                                    <select class="form-select" id="newExpiryYear">
                                        <option value="">YYYY</option>
                                        ${Array.from({length: 10}, (_, i) => new Date().getFullYear() + i).map(y => 
                                            `<option value="${y}">${y}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">CVV</label>
                                    <input type="password" class="form-control" id="newCvv" placeholder="123" maxlength="3">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewCard()">Save Card</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Setup card number formatting for new card
            modal.querySelector('#newCardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                if (value.length > 16) value = value.substring(0, 16);
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
            
            modal.querySelector('#newCvv').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/gi, '');
                if (value.length > 3) value = value.substring(0, 3);
                e.target.value = value;
            });
        }
        
        async function saveNewCard() {
            const cardNumber = document.getElementById('newCardNumber').value.replace(/\s/g, '');
            const cardholderName = document.getElementById('newCardholderName').value;
            const expiryMonth = document.getElementById('newExpiryMonth').value;
            const expiryYear = document.getElementById('newExpiryYear').value;
            const cvv = document.getElementById('newCvv').value;
            
            if (!cardNumber || cardNumber.length !== 16) {
                alert('Please enter a valid 16-digit card number');
                return;
            }
            
            if (!cardholderName || !expiryMonth || !expiryYear || !cvv || cvv.length !== 3) {
                alert('Please fill all card details');
                return;
            }
            
            try {
                const response = await apiRequest('/payments/credit-cards', {
                    method: 'POST',
                    body: JSON.stringify({
                        card_number: cardNumber,
                        cardholder_name: cardholderName,
                        expiry_month: parseInt(expiryMonth),
                        expiry_year: parseInt(expiryYear),
                        cvv: cvv,
                        card_type: 'credit',
                        initial_balance: 10000
                    })
                });
                
                alert('Card saved successfully with ₹10,000 balance!');
                document.querySelector('.modal').remove();
                await loadSavedPaymentMethods(); // Reload to show new card
            } catch (err) {
                alert('Failed to save card: ' + err.message);
            }
        }
        
        async function deleteCard(cardId) {
            if (confirm('Are you sure you want to remove this card?')) {
                try {
                    await apiRequest(`/payments/credit-cards/${cardId}`, { method: 'DELETE' });
                    alert('Card removed successfully!');
                    await loadSavedPaymentMethods();
                } catch (err) {
                    console.error('Delete card error:', err);
                    alert('Failed to remove card: ' + err.message);
                }
            }
        }
        
        function showAddUpiModal() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add UPI ID</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">UPI ID</label>
                                <input type="text" class="form-control" id="newUpiId" placeholder="9876543210@paytm">
                                <small class="text-muted">Enter 10-digit phone number@ybl or @paytm or @gpay (e.g., 9876543210@paytm)</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="saveNewUpiId()">Save UPI ID</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveNewUpiId() {
            const upiId = document.getElementById('newUpiId').value.trim();
            
            // Validate UPI ID format - only 10-digit phone numbers with specific providers
            const validUpiRegex = /^[6-9]\d{9}@(ybl|paytm|gpay)$/;
            
            if (!upiId || !validUpiRegex.test(upiId)) {
                alert('Please enter a valid UPI ID format: 10-digit phone number@ybl or @paytm or @gpay (e.g., 9876543210@paytm)');
                return;
            }
            
            // Store in database via API using correct schema
            apiRequest('/payments/upi-ids', {
                method: 'POST',
                body: JSON.stringify({
                    upi_id: upiId
                })
            }).then(async () => {
                alert('UPI ID saved successfully with ₹10,000 balance!');
                document.querySelector('.modal').remove();
                await loadSavedPaymentMethods(); // Reload to show new UPI ID
            }).catch(err => {
                console.error('Save UPI error:', err);
                alert('Failed to save UPI ID: ' + err.message);
            });
        }
        
        function deleteUpiId(upiId) {
            if (confirm('Are you sure you want to remove this UPI ID?')) {
                apiRequest(`/payments/upi-ids/${upiId}`, { method: 'DELETE' })
                    .then(async () => {
                        alert('UPI ID removed successfully!');
                        await loadSavedPaymentMethods();
                    })
                    .catch(err => {
                        console.error('Delete UPI error:', err);
                        alert('Failed to remove UPI ID: ' + err.message);
                    });
            }
        }
        
        async function showCardTransactions(cardId) {
            try {
                const transactions = await apiRequest(`/payments/credit-cards/${cardId}/transactions`);
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Card Transactions</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                ${transactions.length === 0 ? 
                                    '<p class="text-muted">No transactions found.</p>' :
                                    transactions.map(tx => `
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                            <div>
                                                <small class="fw-bold">${tx.description}</small><br>
                                                <small class="text-muted">${new Date(tx.created_at).toLocaleString()}</small>
                                            </div>
                                            <div class="text-${tx.transaction_type === 'credit' ? 'success' : 'danger'} fw-bold">
                                                ${tx.transaction_type === 'credit' ? '+' : '-'}₹${tx.amount}
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (err) {
                alert('Failed to load transactions: ' + err.message);
            }
        }
        
        async function showUpiTransactions(upiId) {
            try {
                const transactions = await apiRequest(`/payments/upi-ids/${upiId}/transactions`);
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">UPI Transactions</h5>
                                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                ${transactions.length === 0 ? 
                                    '<p class="text-muted">No transactions found.</p>' :
                                    transactions.map(tx => `
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                            <div>
                                                <small class="fw-bold">${tx.description}</small><br>
                                                <small class="text-muted">${new Date(tx.created_at).toLocaleString()}</small>
                                            </div>
                                            <div class="text-${tx.transaction_type === 'credit' ? 'success' : 'danger'} fw-bold">
                                                ${tx.transaction_type === 'credit' ? '+' : '-'}₹${tx.amount}
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (err) {
                alert('Failed to load transactions: ' + err.message);
            }
        }
        
        async function generatePDF(bookingId) {
            try {
                const booking = await apiRequest(`/bookings/${bookingId}`);
                
                // Create PDF content
                const pdfContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="color: #333; margin: 0;">Railway Management System</h1>
                            <h2 style="color: #666; margin: 10px 0;">Booking Confirmation</h2>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <div>
                                <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Booking Details</h3>
                                <p><strong>Booking Reference:</strong> ${booking.booking_reference}</p>
                                <p><strong>Booking Date:</strong> ${new Date(booking.booking_date).toLocaleDateString()}</p>
                                <p><strong>Status:</strong> <span style="color: green; font-weight: bold;">${booking.status.toUpperCase()}</span></p>
                                <p><strong>Total Amount:</strong> ₹${booking.total_amount}</p>
                            </div>
                            
                            <div>
                                <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Journey Details</h3>
                                <p><strong>Train:</strong> ${booking.schedule.route.train.name}</p>
                                <p><strong>Train Number:</strong> ${booking.schedule.route.train.number}</p>
                                <p><strong>Date:</strong> ${booking.schedule.schedule_date}</p>
                                <p><strong>From:</strong> ${booking.schedule.route.source_station.name}</p>
                                <p><strong>To:</strong> ${booking.schedule.route.destination_station.name}</p>
                                <p><strong>Distance:</strong> ${booking.schedule.route.distance_km} km</p>
                                <p><strong>Departure Time:</strong> ${booking.schedule.route.departure_time}</p>
                                <p><strong>Arrival Time:</strong> ${booking.schedule.route.arrival_time}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #333; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Passenger Details</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Name</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Age</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Gender</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${booking.passengers.map(passenger => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 12px;">${passenger.name}</td>
                                            <td style="border: 1px solid #ddd; padding: 12px;">${passenger.age}</td>
                                            <td style="border: 1px solid #ddd; padding: 12px;">${passenger.gender}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
                            <h3 style="color: #333; margin-top: 0;">Payment Information</h3>
                            <p><strong>Payment Method:</strong> ${getPaymentMethodName(booking)}</p>
                            <p><strong>Transaction ID:</strong> TXN${Date.now()}</p>
                            <p><strong>Amount Paid:</strong> ₹${booking.total_amount}</p>
                        </div>
                        
                        <div style="text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ccc; padding-top: 20px;">
                            <p>This is a computer-generated ticket. Please carry a valid ID proof during travel.</p>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Booking Confirmation - ${booking.booking_reference}</title>
                            <style>
                                body { margin: 0; padding: 20px; }
                                @media print {
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            ${pdfContent}
                        </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
            } catch (err) {
                alert('Failed to generate PDF: ' + err.message);
            }
        }
        
        function getPaymentMethodName(booking) {
            const bookingPaymentMethods = JSON.parse(localStorage.getItem('bookingPaymentMethods') || '{}');
            return bookingPaymentMethods[booking.id] || 'Digital Payment';
        }
        
        async function loadSavedCardsForPayment() {
            try {
                savedCards = await apiRequest('/payments/credit-cards');
                const cardsListDiv = document.getElementById('savedCardsList');
                
                if (!cardsListDiv) return;
                
                if (savedCards.length === 0) {
                    cardsListDiv.innerHTML = `
                        <div class="alert alert-info">
                            No saved cards found. <button class="btn btn-link p-0" onclick="showNewCardForm()">Add a new card</button>
                        </div>
                    `;
                } else {
                    cardsListDiv.innerHTML = `
                        <div class="mb-3">
                            ${savedCards.map(card => `
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="savedCard" id="card${card.id}" value="${card.id}" onchange="selectSavedCard(${card.id})">
                                    <label class="form-check-label" for="card${card.id}">
                                        <strong>**** **** **** ${card.card_number.slice(-4)}</strong><br>
                                        <small class="text-muted">${card.cardholder_name}</small><br>
                                        <small class="text-success">Balance: ₹${(card.balance || 0).toLocaleString()}</small>
                                    </label>
                                </div>
                            `).join('')}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="savedCard" id="newCard" value="new" onchange="showNewCardForm()">
                                <label class="form-check-label" for="newCard">
                                    <strong>Add new card</strong>
                                </label>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load saved cards:', err);
                const cardsListDiv = document.getElementById('savedCardsList');
                if (cardsListDiv) {
                    cardsListDiv.innerHTML = `
                        <div class="alert alert-warning">
                            Payment API unavailable. <button class="btn btn-link p-0" onclick="showNewCardForm()">Add a new card</button>
                        </div>
                    `;
                }
                savedCards = []; // Reset to empty array
            }
        }
        
        function selectSavedCard(cardId) {
            selectedCardId = cardId;
            selectedPaymentMethodType = 'Credit Card';
            document.getElementById('newCardForm').style.display = 'none';
        }
        
        function showNewCardForm() {
            selectedCardId = null;
            selectedPaymentMethodType = 'Credit Card';
            document.getElementById('newCardForm').style.display = 'block';
        }
        
        async function loadSavedUpisForPayment() {
            try {
                const upiIds = await apiRequest('/payments/upi-ids');
                const upisListDiv = document.getElementById('savedUpisList');
                
                if (!upisListDiv) return;
                
                if (upiIds.length === 0) {
                    upisListDiv.innerHTML = `
                        <div class="alert alert-info">
                            No saved UPI IDs found. <button class="btn btn-link p-0" onclick="showNewUpiForm()">Add a new UPI ID</button>
                        </div>
                    `;
                } else {
                    upisListDiv.innerHTML = `
                        <div class="mb-3">
                            ${upiIds.map((upi, index) => `
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="savedUpi" id="upi${index}" value="${upi.upi_id}" onchange="selectSavedUpi('${upi.upi_id}', ${index})">
                                    <label class="form-check-label" for="upi${index}">
                                        <strong>${upi.upi_id}</strong><br>
                                        <small class="text-success">Balance: ₹${(upi.balance || 0).toLocaleString()}</small>
                                    </label>
                                </div>
                            `).join('')}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="savedUpi" id="newUpi" value="new" onchange="showNewUpiForm()">
                                <label class="form-check-label" for="newUpi">
                                    <strong>Add new UPI ID</strong>
                                </label>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load UPI IDs:', err);
                const upisListDiv = document.getElementById('savedUpisList');
                if (upisListDiv) {
                    upisListDiv.innerHTML = `
                        <div class="alert alert-warning">
                            UPI API unavailable. <button class="btn btn-link p-0" onclick="showNewUpiForm()">Add a new UPI ID</button>
                        </div>
                    `;
                }
            }
        }
        
        function selectSavedUpi(upiId, index) {
            selectedUpiId = upiId;
            selectedUpiIndex = index;
            selectedPaymentMethodType = 'UPI';
            document.getElementById('newUpiForm').style.display = 'none';
        }
        
        function showNewUpiForm() {
            selectedUpiId = null;
            selectedPaymentMethodType = 'UPI';
            document.getElementById('newUpiForm').style.display = 'block';
        }
    </script>
</body>
</html>