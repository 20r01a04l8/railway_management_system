<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Railway Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-train"></i> Railway Management
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Dashboard</a>
                <a class="nav-link active" href="profile.html">Profile</a>
                <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Profile Info -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user"></i> Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="profileInfo">
                            <!-- Profile info will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-wallet"></i> My Wallet</h5>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
                            <i class="fas fa-plus"></i> Add Money
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h3 class="text-primary">₹<span id="walletBalance">0.00</span></h3>
                                <small class="text-muted">Available Balance</small>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary" onclick="loadWalletTransactions()">View Transactions</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-credit-card"></i> Credit Cards</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCardModal">
                            <i class="fas fa-plus"></i> Add Card
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="creditCardsList">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-mobile-alt"></i> UPI IDs</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUpiModal">
                            <i class="fas fa-plus"></i> Add UPI ID
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="upiIdsList">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Money Modal -->
    <div class="modal fade" id="addMoneyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Money to Wallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="addAmount" placeholder="0.00" min="1" step="0.01">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addMoneyToWallet()">Add Money</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div class="modal fade" id="addCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Credit Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modalCardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="modalCardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalCardholderName" class="form-label">Cardholder Name</label>
                            <input type="text" class="form-control" id="modalCardholderName" placeholder="John Doe">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="modalExpiryMonth" class="form-label">Month</label>
                            <select class="form-control" id="modalExpiryMonth">
                                <option value="">Month</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="modalExpiryYear" class="form-label">Year</label>
                            <select class="form-control" id="modalExpiryYear">
                                <option value="">Year</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="modalCvv" class="form-label">CVV</label>
                            <input type="password" class="form-control" id="modalCvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modalCardType" class="form-label">Card Type</label>
                        <select class="form-control" id="modalCardType">
                            <option value="">Select Card Type</option>
                            <option value="Visa">Visa</option>
                            <option value="MasterCard">MasterCard</option>
                            <option value="RuPay">RuPay</option>
                            <option value="American Express">American Express</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCreditCard()">Add Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add UPI Modal -->
    <div class="modal fade" id="addUpiModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add UPI ID</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalUpiId" class="form-label">UPI ID</label>
                        <input type="text" class="form-control" id="modalUpiId" placeholder="yourname@upi">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addUpiId()">Add UPI ID</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Modal -->
    <div class="modal fade" id="transactionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionsModalTitle">Transactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="transactionsList">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';

        // Load profile data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProfileData();
            loadWalletBalance();
            loadCreditCards();
            loadUpiIds();
        });

        // Load profile information
        async function loadProfileData() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('profileInfo').innerHTML = `
                        <p><strong>Name:</strong> ${user.full_name}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        <p><strong>Member Since:</strong> January 2024</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Load wallet balance
        async function loadWalletBalance() {
            try {
                const response = await fetch(`${API_BASE_URL}/payments/wallet`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const wallet = await response.json();
                    document.getElementById('walletBalance').textContent = wallet.balance;
                }
            } catch (error) {
                console.error('Error loading wallet balance:', error);
            }
        }

        // Load credit cards
        async function loadCreditCards() {
            const cardsList = document.getElementById('creditCardsList');
            try {
                const response = await fetch(`${API_BASE_URL}/payments/credit-cards`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const cards = await response.json();
                    
                    if (cards.length === 0) {
                        cardsList.innerHTML = '<p class="text-muted">No credit cards added yet.</p>';
                        return;
                    }
                    
                    cardsList.innerHTML = cards.map(card => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h6 class="mb-1">${card.card_number}</h6>
                                        <small class="text-muted">${card.cardholder_name} - ${card.card_type}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>₹${card.balance}</strong>
                                        <br><small class="text-muted">Balance</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadCardTransactions(${card.id}, '${card.card_number}')">
                                            <i class="fas fa-history"></i> Transactions
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    cardsList.innerHTML = `<p class="text-danger">Failed to load credit cards: ${errorData.detail}</p>`;
                }
            } catch (error) {
                console.error('Error loading credit cards:', error);
                cardsList.innerHTML = '<p class="text-danger">Unable to connect to server. Please check if the backend is running.</p>';
            }
        }

        // Load UPI IDs
        async function loadUpiIds() {
            const upiList = document.getElementById('upiIdsList');
            try {
                const response = await fetch(`${API_BASE_URL}/payments/upi-ids`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const upiIds = await response.json();
                    
                    if (upiIds.length === 0) {
                        upiList.innerHTML = '<p class="text-muted">No UPI IDs added yet.</p>';
                        return;
                    }
                    
                    upiList.innerHTML = upiIds.map(upi => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h6 class="mb-1">${upi.upi_id}</h6>
                                        <small class="text-muted">Added on ${new Date(upi.created_at).toLocaleDateString()}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>₹${upi.balance}</strong>
                                        <br><small class="text-muted">Balance</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadUpiTransactions(${upi.id}, '${upi.upi_id}')">
                                            <i class="fas fa-history"></i> Transactions
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    upiList.innerHTML = `<p class="text-danger">Failed to load UPI IDs: ${errorData.detail}</p>`;
                }
            } catch (error) {
                console.error('Error loading UPI IDs:', error);
                upiList.innerHTML = '<p class="text-danger">Unable to connect to server. Please check if the backend is running.</p>';
            }
        }

        // Add money to wallet
        async function addMoneyToWallet() {
            const amount = document.getElementById('addAmount').value;
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/payments/wallet/add-money`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ amount: parseFloat(amount) })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    document.getElementById('addAmount').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('addMoneyModal')).hide();
                    loadWalletBalance();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to add money');
                }
            } catch (error) {
                console.error('Error adding money:', error);
                alert('Failed to add money to wallet');
            }
        }

        // Add credit card
        async function addCreditCard() {
            const cardData = {
                card_number: document.getElementById('modalCardNumber').value.replace(/\s/g, ''),
                cardholder_name: document.getElementById('modalCardholderName').value,
                expiry_month: parseInt(document.getElementById('modalExpiryMonth').value),
                expiry_year: parseInt(document.getElementById('modalExpiryYear').value),
                cvv: document.getElementById('modalCvv').value,
                card_type: document.getElementById('modalCardType').value
            };
            
            // Validate
            if (!cardData.card_number || !cardData.cardholder_name || !cardData.expiry_month || !cardData.expiry_year || !cardData.cvv || !cardData.card_type) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/payments/credit-cards`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(cardData)
                });
                
                if (response.ok) {
                    alert('Credit card added successfully!');
                    // Clear form
                    document.getElementById('modalCardNumber').value = '';
                    document.getElementById('modalCardholderName').value = '';
                    document.getElementById('modalExpiryMonth').value = '';
                    document.getElementById('modalExpiryYear').value = '';
                    document.getElementById('modalCvv').value = '';
                    document.getElementById('modalCardType').value = '';
                    
                    bootstrap.Modal.getInstance(document.getElementById('addCardModal')).hide();
                    loadCreditCards();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to add credit card');
                }
            } catch (error) {
                console.error('Error adding credit card:', error);
                alert('Failed to add credit card');
            }
        }

        // Add UPI ID
        async function addUpiId() {
            const upiId = document.getElementById('modalUpiId').value;
            
            if (!upiId || !upiId.includes('@')) {
                alert('Please enter a valid UPI ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/payments/upi-ids`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ upi_id: upiId })
                });
                
                if (response.ok) {
                    alert('UPI ID added successfully!');
                    document.getElementById('modalUpiId').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('addUpiModal')).hide();
                    loadUpiIds();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to add UPI ID');
                }
            } catch (error) {
                console.error('Error adding UPI ID:', error);
                alert('Failed to add UPI ID');
            }
        }

        // Load wallet transactions
        async function loadWalletTransactions() {
            try {
                const response = await fetch(`${API_BASE_URL}/payments/wallet/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const transactions = await response.json();
                    showTransactionsModal('Wallet Transactions', transactions);
                }
            } catch (error) {
                console.error('Error loading wallet transactions:', error);
            }
        }

        // Load card transactions
        async function loadCardTransactions(cardId, cardNumber) {
            try {
                const response = await fetch(`${API_BASE_URL}/payments/credit-cards/${cardId}/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const transactions = await response.json();
                    showTransactionsModal(`${cardNumber} Transactions`, transactions);
                }
            } catch (error) {
                console.error('Error loading card transactions:', error);
            }
        }

        // Load UPI transactions
        async function loadUpiTransactions(upiId, upiIdString) {
            try {
                const response = await fetch(`${API_BASE_URL}/payments/upi-ids/${upiId}/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const transactions = await response.json();
                    showTransactionsModal(`${upiIdString} Transactions`, transactions);
                }
            } catch (error) {
                console.error('Error loading UPI transactions:', error);
            }
        }

        // Show transactions modal
        function showTransactionsModal(title, transactions) {
            document.getElementById('transactionsModalTitle').textContent = title;
            const transactionsList = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = '<p class="text-muted">No transactions found.</p>';
            } else {
                transactionsList.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.map(tx => `
                                    <tr>
                                        <td>${new Date(tx.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <span class="badge bg-${tx.transaction_type === 'credit' ? 'success' : 'danger'}">
                                                ${tx.transaction_type.toUpperCase()}
                                            </span>
                                        </td>
                                        <td class="text-${tx.transaction_type === 'credit' ? 'success' : 'danger'}">
                                            ${tx.transaction_type === 'credit' ? '+' : '-'}₹${tx.amount}
                                        </td>
                                        <td>${tx.description || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('transactionsModal')).show();
        }

        // Format card number input
        document.getElementById('modalCardNumber').addEventListener('input', function() {
            let value = this.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            this.value = formattedValue;
        });

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>